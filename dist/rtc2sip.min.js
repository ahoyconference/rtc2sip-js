function AhoySipCall(a,b,c,d,e,f){var g=this;g.pc=null,g.pc_config=null,g.turn=b&&b.turn||null,g.calledParty=b.calledParty,g.callingParty=b.callingParty,g.timeout=b.timeout,g.sip=b.sip?b.sip:{},g.localStream=c,g.remoteStream=null,g.remoteMedia=d,g.remoteDescription=null,g.remoteIceCandidates=[],g.client=e,g.delegate=f,g.uuid=a||e.generateUuid(),b.audioCodec?g.audioCodec=b.audioCodec.toLowerCase():g.audioCodec=null,void 0!==b.peerAddress?g.peerAddress=b.peerAddress:g.peerAddress=null,void 0!==b.constraints?g.constraints=b.constraints:g.constraints=null,g.isOutgoing=!1,g.isAnswered=!1,g.isOnHold=!1}function AhoySdpForceAudioCodec(a,b){function c(a){var b=null,c=a.split(" ");return c&&c.length&&(c=c[0].split(":"),c&&c.length>1&&(b=c[1])),b}function d(a){var b=a.split(" ");return b&&b.length?b[1].toLowerCase():null}var e=a.split("\r\n"),f=null,g=[],h=[];if(e.forEach(function(a){-1!==a.toLowerCase().indexOf("a=rtpmap:")&&(-1!==a.toLowerCase().indexOf(b)?f=c(a):"telephone-event/8000"===d(a)&&g.push(c(a)))}),!f)return console.log("AhoySdpForceAudioCodec: cannot force audioCodec "+b+" because it is not contained in the SDP"),a;var i=!1;return e.forEach(function(a){if(-1!==a.indexOf("m=audio")){i=!0;var b=a.split(" ");if(b&&b.length>3){var e=b[0]+" "+b[1]+" "+b[2]+" "+f;g.length&&(e+=" "+g.join(" ")),h.push(e)}else h.push(a)}else-1!==a.indexOf("m=")?(i=!1,h.push(a)):i?-1!==a.indexOf("a=rtpmap:")&&c(a)!==f?"telephone-event/8000"===d(a)&&(g.push(c(a)),h.push(a)):-1!==a.indexOf("a=fmtp:")&&c(a)!==f||-1!==a.indexOf("a=rtcp-fb:")&&c(a)!==f||h.push(a):h.push(a)}),h.join("\r\n")}function AhoySipRegistration(a,b,c,d){var e=this;e.username=a.username,e.password=a.password,e.registrar={hostname:a.registrar.hostname,port:a.registrar.port||5060},e.refresh=a.refresh||300,e.proxyUrl=a.proxyUrl,e.useragent=a.useragent,e.callback=d,e.client=b,e.isRegistered=!1,e.delegate=c||function(a){a.reject()},e.register()}!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.adapter=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a,b,c,d,e){var f=i.writeRtpDescription(a.kind,b);if(f+=i.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=i.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":e||"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.direction?"a="+a.direction+"\r\n":a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g="msid:"+d.id+" "+a.rtpSender.track.id+"\r\n";f+="a="+g,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+g,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+g,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),f}function e(a,b){var c=!1;return a=JSON.parse(JSON.stringify(a)),a.filter(function(a){if(a&&(a.urls||a.url)){var d=a.urls||a.url;a.url&&!a.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var e="string"==typeof d;return e&&(d=[d]),d=d.filter(function(a){var d=0===a.indexOf("turn:")&&-1!==a.indexOf("transport=udp")&&-1===a.indexOf("turn:[")&&!c;return d?(c=!0,!0):0===a.indexOf("stun:")&&b>=14393&&-1===a.indexOf("?transport=udp")}),delete a.url,a.urls=e?d[0]:d,!!d.length}return!1})}function f(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]},d=function(a,b){a=parseInt(a,10);for(var c=0;c<b.length;c++)if(b[c].payloadType===a||b[c].preferredPayloadType===a)return b[c]},e=function(a,b,c,e){var f=d(a.parameters.apt,c),g=d(b.parameters.apt,e);return f&&g&&f.name.toLowerCase()===g.name.toLowerCase()};return a.codecs.forEach(function(d){for(var f=0;f<b.codecs.length;f++){var g=b.codecs[f];if(d.name.toLowerCase()===g.name.toLowerCase()&&d.clockRate===g.clockRate){if("rtx"===d.name.toLowerCase()&&d.parameters&&g.parameters.apt&&!e(d,g,a.codecs,b.codecs))continue;g=JSON.parse(JSON.stringify(g)),g.numChannels=Math.min(d.numChannels,g.numChannels),c.codecs.push(g),g.rtcpFeedback=g.rtcpFeedback.filter(function(a){for(var b=0;b<d.rtcpFeedback.length;b++)if(d.rtcpFeedback[b].type===a.type&&d.rtcpFeedback[b].parameter===a.parameter)return!0;return!1});break}}}),a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var e=b.headerExtensions[d];if(a.uri===e.uri){c.headerExtensions.push(e);break}}}),c}function g(a,b,c){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[b][a].indexOf(c)}function h(a,b){var c=a.getRemoteCandidates().find(function(a){return b.foundation===a.foundation&&b.ip===a.ip&&b.port===a.port&&b.priority===a.priority&&b.protocol===a.protocol&&b.type===a.type});return c||a.addRemoteCandidate(b),!c}var i=a("sdp");b.exports=function(a,b){var c=function(c){var d=this,f=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){d[a]=f[a].bind(f)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onicegatheringstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.localDescription=null,this.remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle="max-bundle"===c.bundlePolicy,"negotiate"===c.rtcpMuxPolicy){var g=new Error("rtcpMuxPolicy 'negotiate' is not supported");throw g.name="NotSupportedError",g}switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all"}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced"}if(c.iceServers=e(c.iceServers||[],b),this._iceGatherers=[],c.iceCandidatePoolSize)for(var h=c.iceCandidatePoolSize;h>0;h--)this._iceGatherers=new a.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy});else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=i.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0};return c.prototype._emitGatheringStateChange=function(){var a=new Event("icegatheringstatechange");this.dispatchEvent(a),"function"==typeof this.onicegatheringstatechange&&this.onicegatheringstatechange(a)},c.prototype.getConfiguration=function(){return this._config},c.prototype.getLocalStreams=function(){return this.localStreams},c.prototype.getRemoteStreams=function(){return this.remoteStreams},c.prototype._createTransceiver=function(a){var b=this.transceivers.length>0,c={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:a,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,wantReceive:!0};if(this.usingBundle&&b)c.iceTransport=this.transceivers[0].iceTransport,c.dtlsTransport=this.transceivers[0].dtlsTransport;else{var d=this._createIceAndDtlsTransports();c.iceTransport=d.iceTransport,c.dtlsTransport=d.dtlsTransport}return this.transceivers.push(c),c},c.prototype.addTrack=function(b,c){for(var d,e=0;e<this.transceivers.length;e++)this.transceivers[e].track||this.transceivers[e].kind!==b.kind||(d=this.transceivers[e]);return d||(d=this._createTransceiver(b.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(c)&&this.localStreams.push(c),d.track=b,d.stream=c,d.rtpSender=new a.RTCRtpSender(b,d.dtlsTransport),d.rtpSender},c.prototype.addStream=function(a){var c=this;if(b>=15025)a.getTracks().forEach(function(b){c.addTrack(b,a)});else{var d=a.clone();a.getTracks().forEach(function(a,b){var c=d.getTracks()[b];a.addEventListener("enabled",function(a){c.enabled=a.enabled})}),d.getTracks().forEach(function(a){c.addTrack(a,d)})}},c.prototype.removeStream=function(a){var b=this.localStreams.indexOf(a);b>-1&&(this.localStreams.splice(b,1),this._maybeFireNegotiationNeeded())},c.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})},c.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})},c.prototype._createIceGatherer=function(b,c){var d=this;if(c&&b>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var e=new a.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(e,"state",{value:"new",writable:!0}),this.transceivers[b].candidates=[],this.transceivers[b].bufferCandidates=function(a){var c=!a.candidate||0===Object.keys(a.candidate).length;e.state=c?"completed":"gathering",null!==d.transceivers[b].candidates&&d.transceivers[b].candidates.push(a.candidate)},e.addEventListener("localcandidate",this.transceivers[b].bufferCandidates),e},c.prototype._gather=function(b,c){var d=this,e=this.transceivers[c].iceGatherer;if(!e.onlocalcandidate){var f=this.transceivers[c].candidates;this.transceivers[c].candidates=null,e.removeEventListener("localcandidate",this.transceivers[c].bufferCandidates),e.onlocalcandidate=function(a){if(!(d.usingBundle&&c>0)){var f=new Event("icecandidate");f.candidate={sdpMid:b,sdpMLineIndex:c};var g=a.candidate,h=!g||0===Object.keys(g).length;h?"new"!==e.state&&"gathering"!==e.state||(e.state="completed"):("new"===e.state&&(e.state="gathering"),g.component=1,f.candidate.candidate=i.writeCandidate(g));var j=i.splitSections(d.localDescription.sdp);h?j[f.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n":j[f.candidate.sdpMLineIndex+1]+="a="+f.candidate.candidate+"\r\n",d.localDescription.sdp=j.join("");var k=d.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});"gathering"!==d.iceGatheringState&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),h||(d.dispatchEvent(f),"function"==typeof d.onicecandidate&&d.onicecandidate(f)),k&&(d.dispatchEvent(new Event("icecandidate")),"function"==typeof d.onicecandidate&&d.onicecandidate(new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},a.setTimeout(function(){f.forEach(function(a){var b=new Event("RTCIceGatherEvent");b.candidate=a,e.onlocalcandidate(b)})},0)}},c.prototype._createIceAndDtlsTransports=function(){var b=this,c=new a.RTCIceTransport(null);c.onicestatechange=function(){b._updateConnectionState()};var d=new a.RTCDtlsTransport(c);return d.ondtlsstatechange=function(){b._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),b._updateConnectionState()},{iceTransport:c,dtlsTransport:d}},c.prototype._disposeIceAndDtlsTransports=function(a){var b=this.transceivers[a].iceGatherer;b&&(delete b.onlocalcandidate,delete this.transceivers[a].iceGatherer);var c=this.transceivers[a].iceTransport;c&&(delete c.onicestatechange,delete this.transceivers[a].iceTransport);var d=this.transceivers[a].dtlsTransport;d&&(delete d.ondtlsstatechange,delete d.onerror,delete this.transceivers[a].dtlsTransport)},c.prototype._transceive=function(a,c,d){var e=f(a.localCapabilities,a.remoteCapabilities);c&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:i.localCName,compound:a.rtcpParameters.compound},a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e)),d&&a.rtpReceiver&&e.codecs.length>0&&("video"===a.kind&&a.recvEncodingParameters&&15019>b&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),e.encodings=a.recvEncodingParameters,e.rtcp={cname:a.rtcpParameters.cname,compound:a.rtcpParameters.compound},a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(e))},c.prototype.setLocalDescription=function(a){var b=this,c=arguments;if(!g("setLocalDescription",a.type,this.signalingState))return new Promise(function(d,e){var f=new Error("Can not set local "+a.type+" in state "+b.signalingState);f.name="InvalidStateError",c.length>2&&"function"==typeof c[2]&&c[2].apply(null,[f]),e(f)});var d,e;if("offer"===a.type)d=i.splitSections(a.sdp),e=d.shift(),d.forEach(function(a,c){var d=i.parseRtpParameters(a);b.transceivers[c].localCapabilities=d}),this.transceivers.forEach(function(a,c){b._gather(a.mid,c)});else if("answer"===a.type){d=i.splitSections(b.remoteDescription.sdp),e=d.shift();var h=i.matchPrefix(e,"a=ice-lite").length>0;d.forEach(function(a,c){var d=b.transceivers[c],g=d.iceGatherer,j=d.iceTransport,k=d.dtlsTransport,l=d.localCapabilities,m=d.remoteCapabilities,n=i.isRejected(a)&&1===!i.matchPrefix(a,"a=bundle-only").length;if(!n&&!d.isDatachannel){var o=i.getIceParameters(a,e),p=i.getDtlsParameters(a,e);h&&(p.role="server"),b.usingBundle&&0!==c||(b._gather(d.mid,c),"new"===j.state&&j.start(g,o,h?"controlling":"controlled"),"new"===k.state&&k.start(p));var q=f(l,m);b._transceive(d,q.codecs.length>0,!1)}})}switch(this.localDescription={type:a.type,sdp:a.sdp},a.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}var j=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(a){j&&j.apply(null),a()})},c.prototype.setRemoteDescription=function(c){var d=this,e=arguments;if(!g("setRemoteDescription",c.type,this.signalingState))return new Promise(function(a,b){var f=new Error("Can not set remote "+c.type+" in state "+d.signalingState);f.name="InvalidStateError",e.length>2&&"function"==typeof e[2]&&e[2].apply(null,[f]),b(f)});var f={};this.remoteStreams.forEach(function(a){f[a.id]=a});var j=[],k=i.splitSections(c.sdp),l=k.shift(),m=i.matchPrefix(l,"a=ice-lite").length>0,n=i.matchPrefix(l,"a=group:BUNDLE ").length>0;this.usingBundle=n;var o=i.matchPrefix(l,"a=ice-options:")[0];switch(o?this.canTrickleIceCandidates=o.substr(14).split(" ").indexOf("trickle")>=0:this.canTrickleIceCandidates=!1,k.forEach(function(e,g){var k=i.splitLines(e),o=i.getKind(e),p=i.isRejected(e)&&1===!i.matchPrefix(e,"a=bundle-only").length,q=k[0].substr(2).split(" ")[2],r=i.getDirection(e,l),s=i.parseMsid(e),t=i.getMid(e)||i.generateIdentifier();if("application"===o&&"DTLS/SCTP"===q)return void(d.transceivers[g]={mid:t,isDatachannel:!0});var u,v,w,x,y,z,A,B,C,D,E,F=i.parseRtpParameters(e);p||(D=i.getIceParameters(e,l),E=i.getDtlsParameters(e,l),E.role="client"),A=i.parseRtpEncodingParameters(e);var G=i.parseRtcpParameters(e),H=i.matchPrefix(e,"a=end-of-candidates",l).length>0,I=i.matchPrefix(e,"a=candidate:").map(function(a){return i.parseCandidate(a)}).filter(function(a){return 1===a.component});if(("offer"===c.type||"answer"===c.type)&&!p&&n&&g>0&&d.transceivers[g]&&(d._disposeIceAndDtlsTransports(g),d.transceivers[g].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[g].iceTransport=d.transceivers[0].iceTransport,d.transceivers[g].dtlsTransport=d.transceivers[0].dtlsTransport,d.transceivers[g].rtpSender&&d.transceivers[g].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[g].rtpReceiver&&d.transceivers[g].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport)),"offer"!==c.type||p)"answer"!==c.type||p||(u=d.transceivers[g],v=u.iceGatherer,w=u.iceTransport,x=u.dtlsTransport,y=u.rtpReceiver,z=u.sendEncodingParameters,B=u.localCapabilities,d.transceivers[g].recvEncodingParameters=A,d.transceivers[g].remoteCapabilities=F,d.transceivers[g].rtcpParameters=G,I.length&&"new"===w.state&&(!m&&!H||n&&0!==g?I.forEach(function(a){h(u.iceTransport,a)}):w.setRemoteCandidates(I)),n&&0!==g||("new"===w.state&&w.start(v,D,"controlling"),"new"===x.state&&x.start(E)),d._transceive(u,"sendrecv"===r||"recvonly"===r,"sendrecv"===r||"sendonly"===r),!y||"sendrecv"!==r&&"sendonly"!==r?delete u.rtpReceiver:(C=y.track,s?(f[s.stream]||(f[s.stream]=new a.MediaStream),f[s.stream].addTrack(C),j.push([C,y,f[s.stream]])):(f["default"]||(f["default"]=new a.MediaStream),f["default"].addTrack(C),j.push([C,y,f["default"]]))));else{u=d.transceivers[g]||d._createTransceiver(o),u.mid=t,u.iceGatherer||(u.iceGatherer=d._createIceGatherer(g,n)),I.length&&"new"===u.iceTransport.state&&(!H||n&&0!==g?I.forEach(function(a){h(u.iceTransport,a)}):u.iceTransport.setRemoteCandidates(I)),B=a.RTCRtpReceiver.getCapabilities(o),15019>b&&(B.codecs=B.codecs.filter(function(a){return"rtx"!==a.name})),z=u.sendEncodingParameters||[{ssrc:1001*(2*g+2)}];var J=!1;if(("sendrecv"===r||"sendonly"===r)&&(J=!u.rtpReceiver,y=u.rtpReceiver||new a.RTCRtpReceiver(u.dtlsTransport,o),J)){var K;C=y.track,s?(f[s.stream]||(f[s.stream]=new a.MediaStream,Object.defineProperty(f[s.stream],"id",{get:function(){return s.stream}})),Object.defineProperty(C,"id",{get:function(){return s.track}}),K=f[s.stream]):(f["default"]||(f["default"]=new a.MediaStream),K=f["default"]),K.addTrack(C),j.push([C,y,K])}u.localCapabilities=B,u.remoteCapabilities=F,u.rtpReceiver=y,u.rtcpParameters=G,u.sendEncodingParameters=z,u.recvEncodingParameters=A,d._transceive(d.transceivers[g],!1,J)}}),void 0===this._dtlsRole&&(this._dtlsRole="offer"===c.type?"active":"passive"),this.remoteDescription={type:c.type,sdp:c.sdp},c.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+c.type+'"')}return Object.keys(f).forEach(function(b){var c=f[b];if(c.getTracks().length){if(-1===d.remoteStreams.indexOf(c)){d.remoteStreams.push(c);var e=new Event("addstream");e.stream=c,a.setTimeout(function(){d.dispatchEvent(e),"function"==typeof d.onaddstream&&d.onaddstream(e)})}j.forEach(function(b){var e=b[0],f=b[1];if(c.id===b[2].id){var g=new Event("track");g.track=e,g.receiver=f,g.transceiver={receiver:f},g.streams=[c],a.setTimeout(function(){d.dispatchEvent(g),"function"==typeof d.ontrack&&d.ontrack(g)})}})}}),a.setTimeout(function(){d&&d.transceivers&&d.transceivers.forEach(function(a){a.iceTransport&&"new"===a.iceTransport.state&&a.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),a.iceTransport.addRemoteCandidate({}))})},4e3),new Promise(function(a){e.length>1&&"function"==typeof e[1]&&e[1].apply(null),a()})},c.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._updateSignalingState("closed")},c.prototype._updateSignalingState=function(a){this.signalingState=a;var b=new Event("signalingstatechange");this.dispatchEvent(b),"function"==typeof this.onsignalingstatechange&&this.onsignalingstatechange(b)},c.prototype._maybeFireNegotiationNeeded=function(){var b=this;"stable"===this.signalingState&&this.needNegotiation!==!0&&(this.needNegotiation=!0,a.setTimeout(function(){if(b.needNegotiation!==!1){b.needNegotiation=!1;var a=new Event("negotiationneeded");b.dispatchEvent(a),"function"==typeof b.onnegotiationneeded&&b.onnegotiationneeded(a)}},0))},c.prototype._updateConnectionState=function(){var a,b={"new":0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(a){b[a.iceTransport.state]++,b[a.dtlsTransport.state]++}),b.connected+=b.completed,a="new",b.failed>0?a="failed":b.connecting>0||b.checking>0?a="connecting":b.disconnected>0?a="disconnected":b["new"]>0?a="new":(b.connected>0||b.completed>0)&&(a="connected"),a!==this.iceConnectionState){this.iceConnectionState=a;var c=new Event("iceconnectionstatechange");this.dispatchEvent(c),"function"==typeof this.oniceconnectionstatechange&&this.oniceconnectionstatechange(c)}},c.prototype.createOffer=function(){var c,e=this,f=arguments;1===arguments.length&&"function"!=typeof arguments[0]?c=arguments[0]:3===arguments.length&&(c=arguments[2]);var g=this.transceivers.filter(function(a){return"audio"===a.kind}).length,h=this.transceivers.filter(function(a){return"video"===a.kind}).length;if(c){if(c.mandatory||c.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==c.offerToReceiveAudio&&(g=c.offerToReceiveAudio===!0?1:c.offerToReceiveAudio===!1?0:c.offerToReceiveAudio),void 0!==c.offerToReceiveVideo&&(h=c.offerToReceiveVideo===!0?1:c.offerToReceiveVideo===!1?0:c.offerToReceiveVideo)}for(this.transceivers.forEach(function(a){"audio"===a.kind?(g--,0>g&&(a.wantReceive=!1)):"video"===a.kind&&(h--,0>h&&(a.wantReceive=!1))});g>0||h>0;)g>0&&(this._createTransceiver("audio"),g--),h>0&&(this._createTransceiver("video"),h--);var j=i.writeSessionBoilerplate(this._sdpSessionId,this._sdpSessionVersion++);this.transceivers.forEach(function(c,d){var f=c.track,g=c.kind,h=i.generateIdentifier();c.mid=h,c.iceGatherer||(c.iceGatherer=e._createIceGatherer(d,e.usingBundle));var j=a.RTCRtpSender.getCapabilities(g);15019>b&&(j.codecs=j.codecs.filter(function(a){return"rtx"!==a.name})),j.codecs.forEach(function(a){"H264"===a.name&&void 0===a.parameters["level-asymmetry-allowed"]&&(a.parameters["level-asymmetry-allowed"]="1")});var k=c.sendEncodingParameters||[{ssrc:1001*(2*d+1)}];f&&b>=15019&&"video"===g&&!k[0].rtx&&(k[0].rtx={ssrc:k[0].ssrc+1}),c.wantReceive&&(c.rtpReceiver=new a.RTCRtpReceiver(c.dtlsTransport,g)),c.localCapabilities=j,c.sendEncodingParameters=k}),"max-compat"!==this._config.bundlePolicy&&(j+="a=group:BUNDLE "+this.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),j+="a=ice-options:trickle\r\n",this.transceivers.forEach(function(a,b){j+=d(a,a.localCapabilities,"offer",a.stream,e._dtlsRole),j+="a=rtcp-rsize\r\n",!a.iceGatherer||"new"===e.iceGatheringState||0!==b&&e.usingBundle||(a.iceGatherer.getLocalCandidates().forEach(function(a){a.component=1,j+="a="+i.writeCandidate(a)+"\r\n"}),"completed"===a.iceGatherer.state&&(j+="a=end-of-candidates\r\n"))});var k=new a.RTCSessionDescription({type:"offer",sdp:j});return new Promise(function(a){return f.length>0&&"function"==typeof f[0]?(f[0].apply(null,[k]),void a()):void a(k)})},c.prototype.createAnswer=function(){var c=this,e=arguments,g=i.writeSessionBoilerplate(this._sdpSessionId,this._sdpSessionVersion++);this.usingBundle&&(g+="a=group:BUNDLE "+this.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n");var h=i.splitSections(this.remoteDescription.sdp).length-1;this.transceivers.forEach(function(a,e){if(!(e+1>h)){if(a.isDatachannel)return void(g+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+a.mid+"\r\n");if(a.stream){var i;"audio"===a.kind?i=a.stream.getAudioTracks()[0]:"video"===a.kind&&(i=a.stream.getVideoTracks()[0]),i&&b>=15019&&"video"===a.kind&&!a.sendEncodingParameters[0].rtx&&(a.sendEncodingParameters[0].rtx={ssrc:a.sendEncodingParameters[0].ssrc+1})}var j=f(a.localCapabilities,a.remoteCapabilities),k=j.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length;!k&&a.sendEncodingParameters[0].rtx&&delete a.sendEncodingParameters[0].rtx,g+=d(a,j,"answer",a.stream,c._dtlsRole),a.rtcpParameters&&a.rtcpParameters.reducedSize&&(g+="a=rtcp-rsize\r\n")}});var j=new a.RTCSessionDescription({type:"answer",sdp:g});return new Promise(function(a){return e.length>0&&"function"==typeof e[0]?(e[0].apply(null,[j]),void a()):void a(j)})},c.prototype.addIceCandidate=function(a){var b,c;if(a&&""!==a.candidate){if(void 0===a.sdpMLineIndex&&!a.sdpMid)throw new TypeError("sdpMLineIndex or sdpMid required");if(this.remoteDescription){var d=a.sdpMLineIndex;if(a.sdpMid)for(var e=0;e<this.transceivers.length;e++)if(this.transceivers[e].mid===a.sdpMid){d=e;break}var f=this.transceivers[d];if(f){if(f.isDatachannel)return Promise.resolve();var g=Object.keys(a.candidate).length>0?i.parseCandidate(a.candidate):{};if("tcp"===g.protocol&&(0===g.port||9===g.port))return Promise.resolve();if(g.component&&1!==g.component)return Promise.resolve();if((0===d||d>0&&f.iceTransport!==this.transceivers[0].iceTransport)&&(h(f.iceTransport,g)||(b=new Error("Can not add ICE candidate"),b.name="OperationError")),!b){var j=a.candidate.trim();0===j.indexOf("a=")&&(j=j.substr(2)),c=i.splitSections(this.remoteDescription.sdp),c[d+1]+="a="+(g.type?j:"end-of-candidates")+"\r\n",this.remoteDescription.sdp=c.join("")}}else b=new Error("Can not add ICE candidate"),b.name="OperationError"}else b=new Error("Can not add ICE candidate without a remote description"),b.name="InvalidStateError"}else for(var k=0;k<this.transceivers.length&&(this.transceivers[k].isDatachannel||(this.transceivers[k].iceTransport.addRemoteCandidate({}),c=i.splitSections(this.remoteDescription.sdp),c[k+1]+="a=end-of-candidates\r\n",this.remoteDescription.sdp=c.join(""),!this.usingBundle));k++);var l=arguments;return new Promise(function(a,c){b?(l.length>2&&"function"==typeof l[2]&&l[2].apply(null,[b]),c(b)):(l.length>1&&"function"==typeof l[1]&&l[1].apply(null),a())})},c.prototype.getStats=function(){var a=[];this.transceivers.forEach(function(b){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(c){b[c]&&a.push(b[c].getStats())})});var b=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1],c=function(a){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type};return new Promise(function(d){var e=new Map;Promise.all(a).then(function(a){a.forEach(function(a){Object.keys(a).forEach(function(b){a[b].type=c(a[b]),e.set(b,a[b])})}),b&&b.apply(null,e),d(e)})})},c}},{sdp:2}],2:[function(a,b,c){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},d.localCName=d.generateIdentifier(),d.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})},d.splitSections=function(a){var b=a.split("\nm=");return b.map(function(a,b){return(b>0?"m="+a:a).trim()+"\r\n"})},d.matchPrefix=function(a,b){return d.splitLines(a).filter(function(a){return 0===a.indexOf(b)})},d.parseCandidate=function(a){var b;b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:b[0],component:parseInt(b[1],10),protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],port:parseInt(b[5],10),type:b[7]},d=8;d<b.length;d+=2)switch(b[d]){case"raddr":c.relatedAddress=b[d+1];break;case"rport":c.relatedPort=parseInt(b[d+1],10);break;case"tcptype":c.tcpType=b[d+1];break;case"ufrag":c.ufrag=b[d+1],c.usernameFragment=b[d+1];break;default:c[b[d]]=b[d+1]}return c},d.writeCandidate=function(a){var b=[];b.push(a.foundation),b.push(a.component),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.ip),b.push(a.port);var c=a.type;return b.push("typ"),b.push(c),"host"!==c&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),a.ufrag&&(b.push("ufrag"),b.push(a.ufrag)),"candidate:"+b.join(" ")},d.parseIceOptions=function(a){return a.substr(14).split(" ")},d.parseRtpMap=function(a){var b=a.substr(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return b=b[0].split("/"),c.name=b[0],c.clockRate=parseInt(b[1],10),c.numChannels=3===b.length?parseInt(b[2],10):1,c},d.writeRtpMap=function(a){var b=a.payloadType;return void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType),"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==a.numChannels?"/"+a.numChannels:"")+"\r\n"},d.parseExtmap=function(a){var b=a.substr(9).split(" ");return{id:parseInt(b[0],10),direction:b[0].indexOf("/")>0?b[0].split("/")[1]:"sendrecv",uri:b[1]}},d.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+(a.direction&&"sendrecv"!==a.direction?"/"+a.direction:"")+" "+a.uri+"\r\n"},d.parseFmtp=function(a){for(var b,c={},d=a.substr(a.indexOf(" ")+1).split(";"),e=0;e<d.length;e++)b=d[e].trim().split("="),c[b[0].trim()]=b[1];return c},d.writeFmtp=function(a){var b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&Object.keys(a.parameters).length){var d=[];Object.keys(a.parameters).forEach(function(b){d.push(b+"="+a.parameters[b])}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},d.parseRtcpFb=function(a){var b=a.substr(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},d.writeRtcpFb=function(a){var b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){b+="a=rtcp-fb:"+c+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"}),b},d.parseSsrcMedia=function(a){var b=a.indexOf(" "),c={ssrc:parseInt(a.substr(7,b-7),10)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substr(b+1,d-b-1),c.value=a.substr(d+1)):c.attribute=a.substr(b+1),c},d.getMid=function(a){var b=d.matchPrefix(a,"a=mid:")[0];return b?b.substr(6):void 0},d.parseFingerprint=function(a){var b=a.substr(14).split(" ");return{algorithm:b[0].toLowerCase(),value:b[1]}},d.getDtlsParameters=function(a,b){var c=d.matchPrefix(a+b,"a=fingerprint:");return{role:"auto",fingerprints:c.map(d.parseFingerprint)}},d.writeDtlsParameters=function(a,b){var c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(function(a){c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},d.getIceParameters=function(a,b){var c=d.splitLines(a);c=c.concat(d.splitLines(b));var e={usernameFragment:c.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),password:c.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)};return e},d.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"},d.parseRtpParameters=function(a){for(var b={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=d.splitLines(a),e=c[0].split(" "),f=3;f<e.length;f++){var g=e[f],h=d.matchPrefix(a,"a=rtpmap:"+g+" ")[0];if(h){var i=d.parseRtpMap(h),j=d.matchPrefix(a,"a=fmtp:"+g+" ");switch(i.parameters=j.length?d.parseFmtp(j[0]):{},i.rtcpFeedback=d.matchPrefix(a,"a=rtcp-fb:"+g+" ").map(d.parseRtcpFb),b.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":b.fecMechanisms.push(i.name.toUpperCase())}}}return d.matchPrefix(a,"a=extmap:").forEach(function(a){b.headerExtensions.push(d.parseExtmap(a))}),b},d.writeRtpDescription=function(a,b){var c="";c+="m="+a+" ",c+=b.codecs.length>0?"9":"0",c+=" UDP/TLS/RTP/SAVPF ",c+=b.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n",c+="c=IN IP4 0.0.0.0\r\n",c+="a=rtcp:9 IN IP4 0.0.0.0\r\n",b.codecs.forEach(function(a){c+=d.writeRtpMap(a),c+=d.writeFmtp(a),c+=d.writeRtcpFb(a)});var e=0;return b.codecs.forEach(function(a){a.maxptime>e&&(e=a.maxptime)}),e>0&&(c+="a=maxptime:"+e+"\r\n"),
c+="a=rtcp-mux\r\n",b.headerExtensions.forEach(function(a){c+=d.writeExtmap(a)}),c},d.parseRtpEncodingParameters=function(a){var b,c=[],e=d.parseRtpParameters(a),f=-1!==e.fecMechanisms.indexOf("RED"),g=-1!==e.fecMechanisms.indexOf("ULPFEC"),h=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),i=h.length>0&&h[0].ssrc,j=d.matchPrefix(a,"a=ssrc-group:FID").map(function(a){var b=a.split(" ");return b.shift(),b.map(function(a){return parseInt(a,10)})});j.length>0&&j[0].length>1&&j[0][0]===i&&(b=j[0][1]),e.codecs.forEach(function(a){if("RTX"===a.name.toUpperCase()&&a.parameters.apt){var d={ssrc:i,codecPayloadType:parseInt(a.parameters.apt,10),rtx:{ssrc:b}};c.push(d),f&&(d=JSON.parse(JSON.stringify(d)),d.fec={ssrc:b,mechanism:g?"red+ulpfec":"red"},c.push(d))}}),0===c.length&&i&&c.push({ssrc:i});var k=d.matchPrefix(a,"b=");return k.length&&(k=0===k[0].indexOf("b=TIAS:")?parseInt(k[0].substr(7),10):0===k[0].indexOf("b=AS:")?1e3*parseInt(k[0].substr(5),10)*.95-16e3:void 0,c.forEach(function(a){a.maxBitrate=k})),c},d.parseRtcpParameters=function(a){var b={},c=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];c&&(b.cname=c.value,b.ssrc=c.ssrc);var e=d.matchPrefix(a,"a=rtcp-rsize");b.reducedSize=e.length>0,b.compound=0===e.length;var f=d.matchPrefix(a,"a=rtcp-mux");return b.mux=f.length>0,b},d.parseMsid=function(a){var b,c=d.matchPrefix(a,"a=msid:");if(1===c.length)return b=c[0].substr(7).split(" "),{stream:b[0],track:b[1]};var e=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"msid"===a.attribute});return e.length>0?(b=e[0].value.split(" "),{stream:b[0],track:b[1]}):void 0},d.generateSessionId=function(){return Math.random().toString().substr(2,21)},d.writeSessionBoilerplate=function(a,b){var c,e=void 0!==b?b:2;return c=a?a:d.generateSessionId(),"v=0\r\no=thisisadapterortc "+c+" "+e+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},d.writeMediaSection=function(a,b,c,e){var f=d.writeRtpDescription(a.kind,b);if(f+=d.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=d.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.direction?"a="+a.direction+"\r\n":a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g="msid:"+e.id+" "+a.rtpSender.track.id+"\r\n";f+="a="+g,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+g,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+g,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"),f},d.getDirection=function(a,b){for(var c=d.splitLines(a),e=0;e<c.length;e++)switch(c[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[e].substr(2)}return b?d.getDirection(b):"sendrecv"},d.getKind=function(a){var b=d.splitLines(a),c=b[0].split(" ");return c[0].substr(2)},d.isRejected=function(a){return"0"===a.split(" ",2)[1]},d.parseMLine=function(a){var b=d.splitLines(a),c=b[0].split(" ");return{kind:c[0].substr(2),port:parseInt(c[1],10),protocol:c[2],fmt:c.slice(3).join(" ")}},"object"==typeof b&&(b.exports=d)},{}],3:[function(a,b,c){(function(c){"use strict";var d=a("./adapter_factory.js");b.exports=d({window:c.window})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":4}],4:[function(a,b,c){"use strict";var d=a("./utils");b.exports=function(b,c){var e=b&&b.window,f={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var g in c)hasOwnProperty.call(c,g)&&(f[g]=c[g]);var h=d.log,i=d.detectBrowser(e),j={browserDetails:i,extractVersion:d.extractVersion,disableLog:d.disableLog,disableWarnings:d.disableWarnings},k=a("./chrome/chrome_shim")||null,l=a("./edge/edge_shim")||null,m=a("./firefox/firefox_shim")||null,n=a("./safari/safari_shim")||null,o=a("./common_shim")||null;switch(i.browser){case"chrome":if(!k||!k.shimPeerConnection||!f.shimChrome)return h("Chrome shim is not included in this adapter release."),j;h("adapter.js shimming chrome."),j.browserShim=k,o.shimCreateObjectURL(e),k.shimGetUserMedia(e),k.shimMediaStream(e),k.shimSourceObject(e),k.shimPeerConnection(e),k.shimOnTrack(e),k.shimAddTrackRemoveTrack(e),k.shimGetSendersWithDtmf(e),o.shimRTCIceCandidate(e);break;case"firefox":if(!m||!m.shimPeerConnection||!f.shimFirefox)return h("Firefox shim is not included in this adapter release."),j;h("adapter.js shimming firefox."),j.browserShim=m,o.shimCreateObjectURL(e),m.shimGetUserMedia(e),m.shimSourceObject(e),m.shimPeerConnection(e),m.shimOnTrack(e),o.shimRTCIceCandidate(e);break;case"edge":if(!l||!l.shimPeerConnection||!f.shimEdge)return h("MS edge shim is not included in this adapter release."),j;h("adapter.js shimming edge."),j.browserShim=l,o.shimCreateObjectURL(e),l.shimGetUserMedia(e),l.shimPeerConnection(e),l.shimReplaceTrack(e);break;case"safari":if(!n||!f.shimSafari)return h("Safari shim is not included in this adapter release."),j;h("adapter.js shimming safari."),j.browserShim=n,o.shimCreateObjectURL(e),n.shimRTCIceServerUrls(e),n.shimCallbacksAPI(e),n.shimLocalStreamsAPI(e),n.shimRemoteStreamsAPI(e),n.shimTrackEventTransceiver(e),n.shimGetUserMedia(e),n.shimCreateOfferLegacy(e),o.shimRTCIceCandidate(e);break;default:h("Unsupported browser!")}return j}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":10,"./safari/safari_shim":12,"./utils":13}],5:[function(a,b,c){"use strict";var d=a("../utils.js"),e=d.log,f={shimMediaStream:function(a){a.MediaStream=a.MediaStream||a.webkitMediaStream},shimOnTrack:function(a){if("object"==typeof a&&a.RTCPeerConnection&&!("ontrack"in a.RTCPeerConnection.prototype)){Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=a)}});var b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){var c=this;return c._ontrackpoly||(c._ontrackpoly=function(b){b.stream.addEventListener("addtrack",function(d){var e;e=a.RTCPeerConnection.prototype.getReceivers?c.getReceivers().find(function(a){return a.track&&a.track.id===d.track.id}):{track:d.track};var f=new Event("track");f.track=d.track,f.receiver=e,f.transceiver={receiver:e},f.streams=[b.stream],c.dispatchEvent(f)}),b.stream.getTracks().forEach(function(d){var e;e=a.RTCPeerConnection.prototype.getReceivers?c.getReceivers().find(function(a){return a.track&&a.track.id===d.id}):{track:d};var f=new Event("track");f.track=d,f.receiver=e,f.transceiver={receiver:e},f.streams=[b.stream],c.dispatchEvent(f)})},c.addEventListener("addstream",c._ontrackpoly)),b.apply(c,arguments)}}},shimGetSendersWithDtmf:function(a){if("object"==typeof a&&a.RTCPeerConnection&&!("getSenders"in a.RTCPeerConnection.prototype)&&"createDTMFSender"in a.RTCPeerConnection.prototype){var b=function(a,b){return{track:b,get dtmf(){return void 0===this._dtmf&&("audio"===b.kind?this._dtmf=a.createDTMFSender(b):this._dtmf=null),this._dtmf},_pc:a}};if(!a.RTCPeerConnection.prototype.getSenders){a.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var c=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,d){var e=this,f=c.apply(e,arguments);return f||(f=b(e,a),e._senders.push(f)),f};var d=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;d.apply(b,arguments);var c=b._senders.indexOf(a);-1!==c&&b._senders.splice(c,1)}}var e=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var c=this;c._senders=c._senders||[],e.apply(c,[a]),a.getTracks().forEach(function(a){c._senders.push(b(c,a))})};var f=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;b._senders=b._senders||[],f.apply(b,[a]),a.getTracks().forEach(function(a){var c=b._senders.find(function(b){return b.track===a});c&&b._senders.splice(b._senders.indexOf(c),1)})}}else if("object"==typeof a&&a.RTCPeerConnection&&"getSenders"in a.RTCPeerConnection.prototype&&"createDTMFSender"in a.RTCPeerConnection.prototype&&a.RTCRtpSender&&!("dtmf"in a.RTCRtpSender.prototype)){var g=a.RTCPeerConnection.prototype.getSenders;a.RTCPeerConnection.prototype.getSenders=function(){var a=this,b=g.apply(a,[]);return b.forEach(function(b){b._pc=a}),b},Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSourceObject:function(a){var b=a&&a.URL;"object"==typeof a&&(!a.HTMLMediaElement||"srcObject"in a.HTMLMediaElement.prototype||Object.defineProperty(a.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(a){var c=this;return this._srcObject=a,this.src&&b.revokeObjectURL(this.src),a?(this.src=b.createObjectURL(a),a.addEventListener("addtrack",function(){c.src&&b.revokeObjectURL(c.src),c.src=b.createObjectURL(a)}),void a.addEventListener("removetrack",function(){c.src&&b.revokeObjectURL(c.src),c.src=b.createObjectURL(a)})):void(this.src="")}}))},shimAddTrackRemoveTrack:function(a){function b(a,b){var c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(function(b){var d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(new RegExp(e.id,"g"),d.id)}),new RTCSessionDescription({type:b.type,sdp:c})}function c(a,b){var c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(function(b){var d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(new RegExp(d.id,"g"),e.id)}),new RTCSessionDescription({type:b.type,sdp:c})}var e=d.detectBrowser(a);if(!(a.RTCPeerConnection.prototype.addTrack&&e.version>=63)){var f=a.RTCPeerConnection.prototype.getLocalStreams;a.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this,b=f.apply(this);return a._reverseStreams=a._reverseStreams||{},b.map(function(b){return a._reverseStreams[b.id]})};var g=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(b){var c=this;if(c._streams=c._streams||{},c._reverseStreams=c._reverseStreams||{},b.getTracks().forEach(function(a){var b=c.getSenders().find(function(b){return b.track===a});if(b)throw new DOMException("Track already exists.","InvalidAccessError")}),!c._reverseStreams[b.id]){var d=new a.MediaStream(b.getTracks());c._streams[b.id]=d,c._reverseStreams[d.id]=b,b=d}g.apply(c,[b])};var h=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;b._streams=b._streams||{},b._reverseStreams=b._reverseStreams||{},h.apply(b,[b._streams[a.id]||a]),delete b._reverseStreams[b._streams[a.id]?b._streams[a.id].id:a.id],delete b._streams[a.id]},a.RTCPeerConnection.prototype.addTrack=function(b,c){var d=this;if("closed"===d.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var e=[].slice.call(arguments,1);if(1!==e.length||!e[0].getTracks().find(function(a){return a===b}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var f=d.getSenders().find(function(a){return a.track===b});if(f)throw new DOMException("Track already exists.","InvalidAccessError");d._streams=d._streams||{},d._reverseStreams=d._reverseStreams||{};var g=d._streams[c.id];if(g)g.addTrack(b),Promise.resolve().then(function(){d.dispatchEvent(new Event("negotiationneeded"))});else{var h=new a.MediaStream([b]);d._streams[c.id]=h,d._reverseStreams[h.id]=c,d.addStream(h)}return d.getSenders().find(function(a){return a.track===b})},["createOffer","createAnswer"].forEach(function(c){var d=a.RTCPeerConnection.prototype[c];a.RTCPeerConnection.prototype[c]=function(){var a=this,c=arguments,e=arguments.length&&"function"==typeof arguments[0];return e?d.apply(a,[function(d){var e=b(a,d);c[0].apply(null,[e])},function(a){c[1]&&c[1].apply(null,a)},arguments[2]]):d.apply(a,arguments).then(function(c){return b(a,c)})}});var i=a.RTCPeerConnection.prototype.setLocalDescription;a.RTCPeerConnection.prototype.setLocalDescription=function(){var a=this;return arguments.length&&arguments[0].type?(arguments[0]=c(a,arguments[0]),i.apply(a,arguments)):i.apply(a,arguments)};var j=Object.getOwnPropertyDescriptor(a.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(a.RTCPeerConnection.prototype,"localDescription",{get:function(){var a=this,c=j.get.apply(this);return""===c.type?c:b(a,c)}}),a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;if("closed"===b.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!a._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var c=a._pc===b;if(!c)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");b._streams=b._streams||{};var d;Object.keys(b._streams).forEach(function(c){var e=b._streams[c].getTracks().find(function(b){return a.track===b});e&&(d=b._streams[c])}),d&&(1===d.getTracks().length?b.removeStream(b._reverseStreams[d.id]):d.removeTrack(a.track),b.dispatchEvent(new Event("negotiationneeded")))}}},shimPeerConnection:function(a){var b=d.detectBrowser(a);if(a.RTCPeerConnection){var c=a.RTCPeerConnection;a.RTCPeerConnection=function(a,b){if(a&&a.iceServers){for(var e=[],f=0;f<a.iceServers.length;f++){var g=a.iceServers[f];!g.hasOwnProperty("urls")&&g.hasOwnProperty("url")?(d.deprecated("RTCIceServer.url","RTCIceServer.urls"),g=JSON.parse(JSON.stringify(g)),g.urls=g.url,e.push(g)):e.push(a.iceServers[f])}a.iceServers=e}return new c(a,b)},a.RTCPeerConnection.prototype=c.prototype,Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return c.generateCertificate}})}else a.RTCPeerConnection=function(b,c){return e("PeerConnection"),b&&b.iceTransportPolicy&&(b.iceTransports=b.iceTransportPolicy),new a.webkitRTCPeerConnection(b,c)},a.RTCPeerConnection.prototype=a.webkitRTCPeerConnection.prototype,a.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return a.webkitRTCPeerConnection.generateCertificate}});var f=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(a,b,c){var d=this,e=arguments;if(arguments.length>0&&"function"==typeof a)return f.apply(this,arguments);if(0===f.length&&(0===arguments.length||"function"!=typeof arguments[0]))return f.apply(this,[]);var g=function(a){var b={},c=a.result();return c.forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b},h=function(a){return new Map(Object.keys(a).map(function(b){return[b,a[b]]}))};if(arguments.length>=2){var i=function(a){e[1](h(g(a)))};return f.apply(this,[i,arguments[0]])}return new Promise(function(a,b){f.apply(d,[function(b){a(h(g(b)))},b])}).then(b,c)},b.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){var a=arguments,b=this,d=new Promise(function(d,e){c.apply(b,[a[0],d,e])});return a.length<2?d:d.then(function(){a[1].apply(null,[])},function(b){a.length>=3&&a[2].apply(null,[b])})}}),b.version<52&&["createOffer","createAnswer"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var b=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){c.apply(a,[d,e,b])})}return c.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)}});var g=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?g.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};b.exports={shimMediaStream:f.shimMediaStream,shimOnTrack:f.shimOnTrack,shimAddTrackRemoveTrack:f.shimAddTrackRemoveTrack,shimGetSendersWithDtmf:f.shimGetSendersWithDtmf,shimSourceObject:f.shimSourceObject,shimPeerConnection:f.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils.js":13,"./getusermedia":6}],6:[function(a,b,c){"use strict";var d=a("../utils.js"),e=d.log;b.exports=function(a){var b=d.detectBrowser(a),c=a&&a.navigator,f=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var f={};"number"==typeof d.ideal?(f[e("min",c)]=d.ideal,b.optional.push(f),f={},f[e("max",c)]=d.ideal,b.optional.push(f)):(f[e("",c)]=d.ideal,b.optional.push(f))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b},g=function(a,d){if(a=JSON.parse(JSON.stringify(a)),a&&"object"==typeof a.audio){var g=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])};a=JSON.parse(JSON.stringify(a)),g(a.audio,"autoGainControl","googAutoGainControl"),g(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=f(a.audio)}if(a&&"object"==typeof a.video){var h=a.video.facingMode;h=h&&("object"==typeof h?h:{ideal:h});var i=b.version<66;if(h&&("user"===h.exact||"environment"===h.exact||"user"===h.ideal||"environment"===h.ideal)&&(!c.mediaDevices.getSupportedConstraints||!c.mediaDevices.getSupportedConstraints().facingMode||i)){delete a.video.facingMode;var j;if("environment"===h.exact||"environment"===h.ideal?j=["back","rear"]:"user"!==h.exact&&"user"!==h.ideal||(j=["front"]),j)return c.mediaDevices.enumerateDevices().then(function(b){b=b.filter(function(a){return"videoinput"===a.kind});var c=b.find(function(a){return j.some(function(b){return-1!==a.label.toLowerCase().indexOf(b)})});return!c&&b.length&&-1!==j.indexOf("back")&&(c=b[b.length-1]),c&&(a.video.deviceId=h.exact?{exact:c.deviceId}:{ideal:c.deviceId}),a.video=f(a.video),e("chrome: "+JSON.stringify(a)),d(a)})}a.video=f(a.video)}return e("chrome: "+JSON.stringify(a)),d(a)},h=function(a){return{name:{PermissionDeniedError:"NotAllowedError",InvalidStateError:"NotReadableError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotReadableError",MediaDeviceKillSwitchOn:"NotReadableError"}[a.name]||a.name,message:a.message,constraint:a.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},i=function(a,b,d){g(a,function(a){c.webkitGetUserMedia(a,b,function(a){d&&d(h(a))})})};c.getUserMedia=i;var j=function(a){return new Promise(function(b,d){c.getUserMedia(a,b,d)})};if(c.mediaDevices||(c.mediaDevices={getUserMedia:j,enumerateDevices:function(){return new Promise(function(b){var c={audio:"audioinput",video:"videoinput"};return a.MediaStreamTrack.getSources(function(a){b(a.map(function(a){return{label:a.label,kind:c[a.kind],deviceId:a.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),c.mediaDevices.getUserMedia){var k=c.mediaDevices.getUserMedia.bind(c.mediaDevices);c.mediaDevices.getUserMedia=function(a){return g(a,function(a){return k(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");return b},function(a){return Promise.reject(h(a))})})}}else c.mediaDevices.getUserMedia=function(a){return j(a)};"undefined"==typeof c.mediaDevices.addEventListener&&(c.mediaDevices.addEventListener=function(){e("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof c.mediaDevices.removeEventListener&&(c.mediaDevices.removeEventListener=function(){e("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":13}],7:[function(a,b,c){"use strict";function d(a,b,c){if(a.RTCPeerConnection){var d=a.RTCPeerConnection.prototype,e=d.addEventListener;d.addEventListener=function(a,d){if(a!==b)return e.apply(this,arguments);var f=function(a){d(c(a))};return this._eventMap=this._eventMap||{},this._eventMap[d]=f,e.apply(this,[a,f])};var f=d.removeEventListener;d.removeEventListener=function(a,c){if(a!==b||!this._eventMap||!this._eventMap[c])return f.apply(this,arguments);var d=this._eventMap[c];return delete this._eventMap[c],f.apply(this,[a,d])},Object.defineProperty(d,"on"+b,{get:function(){return this["_on"+b]},set:function(a){this["_on"+b]&&(this.removeEventListener(b,this["_on"+b]),delete this["_on"+b]),a&&this.addEventListener(b,this["_on"+b]=a)}})}}var e=a("sdp"),f=a("./utils");b.exports={shimRTCIceCandidate:function(a){if(!(a.RTCIceCandidate&&"foundation"in a.RTCIceCandidate.prototype)){var b=a.RTCIceCandidate;a.RTCIceCandidate=function(a){"object"==typeof a&&a.candidate&&0===a.candidate.indexOf("a=")&&(a=JSON.parse(JSON.stringify(a)),a.candidate=a.candidate.substr(2));var c=new b(a),d=e.parseCandidate(a.candidate),f=Object.assign(c,d);return f.toJSON=function(){return{candidate:f.candidate,sdpMid:f.sdpMid,sdpMLineIndex:f.sdpMLineIndex,usernameFragment:f.usernameFragment}},f},d(a,"icecandidate",function(b){return b.candidate&&Object.defineProperty(b,"candidate",{value:new a.RTCIceCandidate(b.candidate),writable:"false"}),b})}},shimCreateObjectURL:function(a){var b=a&&a.URL;if("object"==typeof a&&a.HTMLMediaElement&&"srcObject"in a.HTMLMediaElement.prototype&&b.createObjectURL&&b.revokeObjectURL){var c=b.createObjectURL.bind(b),d=b.revokeObjectURL.bind(b),e=new Map,g=0;b.createObjectURL=function(a){if("getTracks"in a){var b="polyblob:"+ ++g;return e.set(b,a),f.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),b}return c(a)},b.revokeObjectURL=function(a){d(a),e["delete"](a)};var h=Object.getOwnPropertyDescriptor(a.HTMLMediaElement.prototype,"src");Object.defineProperty(a.HTMLMediaElement.prototype,"src",{get:function(){return h.get.apply(this)},set:function(a){return this.srcObject=e.get(a)||null,h.set.apply(this,[a])}});var i=a.HTMLMediaElement.prototype.setAttribute;a.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=e.get(arguments[1])||null),i.apply(this,arguments)}}}}},{"./utils":13,sdp:2}],8:[function(a,b,c){"use strict";var d=a("../utils"),e=a("rtcpeerconnection-shim");b.exports={shimGetUserMedia:a("./getusermedia"),shimPeerConnection:function(a){var b=d.detectBrowser(a);if(a.RTCIceGatherer&&(a.RTCIceCandidate||(a.RTCIceCandidate=function(a){return a}),a.RTCSessionDescription||(a.RTCSessionDescription=function(a){return a}),b.version<15025)){var c=Object.getOwnPropertyDescriptor(a.MediaStreamTrack.prototype,"enabled");Object.defineProperty(a.MediaStreamTrack.prototype,"enabled",{set:function(a){c.set.call(this,a);var b=new Event("enabled");b.enabled=a,this.dispatchEvent(b)}})}!a.RTCRtpSender||"dtmf"in a.RTCRtpSender.prototype||Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new a.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),a.RTCPeerConnection=e(a,b.version)},shimReplaceTrack:function(a){!a.RTCRtpSender||"replaceTrack"in a.RTCRtpSender.prototype||(a.RTCRtpSender.prototype.replaceTrack=a.RTCRtpSender.prototype.setTrack)}}},{"../utils":13,"./getusermedia":9,"rtcpeerconnection-shim":1}],9:[function(a,b,c){"use strict";b.exports=function(a){var b=a&&a.navigator,c=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString:function(){return this.name}}},d=b.mediaDevices.getUserMedia.bind(b.mediaDevices);b.mediaDevices.getUserMedia=function(a){return d(a)["catch"](function(a){return Promise.reject(c(a))})}}},{}],10:[function(a,b,c){"use strict";var d=a("../utils"),e={shimOnTrack:function(a){"object"!=typeof a||!a.RTCPeerConnection||"ontrack"in a.RTCPeerConnection.prototype||Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.transceiver={receiver:c.receiver},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))}}),"object"==typeof a&&a.RTCTrackEvent&&"receiver"in a.RTCTrackEvent.prototype&&!("transceiver"in a.RTCTrackEvent.prototype)&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(a){"object"==typeof a&&(!a.HTMLMediaElement||"srcObject"in a.HTMLMediaElement.prototype||Object.defineProperty(a.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(a){this.mozSrcObject=a}}))},shimPeerConnection:function(a){var b=d.detectBrowser(a);if("object"==typeof a&&(a.RTCPeerConnection||a.mozRTCPeerConnection)){a.RTCPeerConnection||(a.RTCPeerConnection=function(c,d){if(b.version<38&&c&&c.iceServers){for(var e=[],f=0;f<c.iceServers.length;f++){var g=c.iceServers[f];if(g.hasOwnProperty("urls"))for(var h=0;h<g.urls.length;h++){var i={url:g.urls[h]};0===g.urls[h].indexOf("turn")&&(i.username=g.username,i.credential=g.credential),e.push(i)}else e.push(c.iceServers[f])}c.iceServers=e}return new a.mozRTCPeerConnection(c,d)},a.RTCPeerConnection.prototype=a.mozRTCPeerConnection.prototype,a.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return a.mozRTCPeerConnection.generateCertificate}}),a.RTCSessionDescription=a.mozRTCSessionDescription,a.RTCIceCandidate=a.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)}});var c=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?c.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var e=function(a){var b=new Map;return Object.keys(a).forEach(function(c){b.set(c,a[c]),b[c]=a[c]}),b},f={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},g=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(a,c,d){return g.apply(this,[a||null]).then(function(a){if(b.version<48&&(a=e(a)),b.version<53&&!c)try{a.forEach(function(a){a.type=f[a.type]||a.type})}catch(d){if("TypeError"!==d.name)throw d;a.forEach(function(b,c){a.set(c,Object.assign({},b,{type:f[b.type]||b.type}))})}return a}).then(c,d)}}}};b.exports={shimOnTrack:e.shimOnTrack,shimSourceObject:e.shimSourceObject,shimPeerConnection:e.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils":13,"./getusermedia":11}],11:[function(a,b,c){"use strict";var d=a("../utils"),e=d.log;b.exports=function(a){var b=d.detectBrowser(a),c=a&&a.navigator,f=a&&a.MediaStreamTrack,g=function(a){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[a.name]||a.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[a.message]||a.message,constraint:a.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},h=function(a,d,f){var h=function(a){if("object"!=typeof a||a.require)return a;var b=[];return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"==typeof a[c]?a[c]:{ideal:a[c]};if(void 0===d.min&&void 0===d.max&&void 0===d.exact||b.push(c),void 0!==d.exact&&("number"==typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact),void 0!==d.ideal){a.advanced=a.advanced||[];var e={};"number"==typeof d.ideal?e[c]={min:d.ideal,max:d.ideal}:e[c]=d.ideal,a.advanced.push(e),delete d.ideal,Object.keys(d).length||delete a[c]}}}),b.length&&(a.require=b),a};return a=JSON.parse(JSON.stringify(a)),b.version<38&&(e("spec: "+JSON.stringify(a)),a.audio&&(a.audio=h(a.audio)),a.video&&(a.video=h(a.video)),e("ff37: "+JSON.stringify(a))),c.mozGetUserMedia(a,d,function(a){f(g(a))})},i=function(a){return new Promise(function(b,c){h(a,b,c)})};if(c.mediaDevices||(c.mediaDevices={getUserMedia:i,addEventListener:function(){},removeEventListener:function(){}}),c.mediaDevices.enumerateDevices=c.mediaDevices.enumerateDevices||function(){return new Promise(function(a){var b=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];a(b)})},b.version<41){var j=c.mediaDevices.enumerateDevices.bind(c.mediaDevices);c.mediaDevices.enumerateDevices=function(){return j().then(void 0,function(a){if("NotFoundError"===a.name)return[];throw a})}}if(b.version<49){var k=c.mediaDevices.getUserMedia.bind(c.mediaDevices);c.mediaDevices.getUserMedia=function(a){return k(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("The object can not be found here.","NotFoundError");return b},function(a){return Promise.reject(g(a))})}}if(!(b.version>55&&"autoGainControl"in c.mediaDevices.getSupportedConstraints())){var l=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])},m=c.mediaDevices.getUserMedia.bind(c.mediaDevices);if(c.mediaDevices.getUserMedia=function(a){return"object"==typeof a&&"object"==typeof a.audio&&(a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","mozAutoGainControl"),l(a.audio,"noiseSuppression","mozNoiseSuppression")),m(a)},f&&f.prototype.getSettings){var n=f.prototype.getSettings;f.prototype.getSettings=function(){var a=n.apply(this,arguments);return l(a,"mozAutoGainControl","autoGainControl"),l(a,"mozNoiseSuppression","noiseSuppression"),a}}if(f&&f.prototype.applyConstraints){var o=f.prototype.applyConstraints;f.prototype.applyConstraints=function(a){return"audio"===this.kind&&"object"==typeof a&&(a=JSON.parse(JSON.stringify(a)),
l(a,"autoGainControl","mozAutoGainControl"),l(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}c.getUserMedia=function(a,e,f){return b.version<44?h(a,e,f):(d.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),void c.mediaDevices.getUserMedia(a).then(e,f))}}},{"../utils":13}],12:[function(a,b,c){"use strict";var d=a("../utils"),e={shimLocalStreamsAPI:function(a){if("object"==typeof a&&a.RTCPeerConnection){if("getLocalStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getStreamById=function(a){var b=null;return this._localStreams&&this._localStreams.forEach(function(c){c.id===a&&(b=c)}),this._remoteStreams&&this._remoteStreams.forEach(function(c){c.id===a&&(b=c)}),b}),!("addStream"in a.RTCPeerConnection.prototype)){var b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addStream=function(a){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(a)&&this._localStreams.push(a);var c=this;a.getTracks().forEach(function(d){b.call(c,d,a)})},a.RTCPeerConnection.prototype.addTrack=function(a,c){c&&(this._localStreams?-1===this._localStreams.indexOf(c)&&this._localStreams.push(c):this._localStreams=[c]),b.call(this,a,c)}}"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){this._localStreams||(this._localStreams=[]);var b=this._localStreams.indexOf(a);if(-1!==b){this._localStreams.splice(b,1);var c=this,d=a.getTracks();this.getSenders().forEach(function(a){-1!==d.indexOf(a.track)&&c.removeTrack(a)})}})}},shimRemoteStreamsAPI:function(a){"object"==typeof a&&a.RTCPeerConnection&&("getRemoteStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),"onaddstream"in a.RTCPeerConnection.prototype||Object.defineProperty(a.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(a){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=a),this.addEventListener("track",this._onaddstreampoly=function(a){var b=a.streams[0];if(this._remoteStreams||(this._remoteStreams=[]),!(this._remoteStreams.indexOf(b)>=0)){this._remoteStreams.push(b);var c=new Event("addstream");c.stream=a.streams[0],this.dispatchEvent(c)}}.bind(this))}}))},shimCallbacksAPI:function(a){if("object"==typeof a&&a.RTCPeerConnection){var b=a.RTCPeerConnection.prototype,c=b.createOffer,d=b.createAnswer,e=b.setLocalDescription,f=b.setRemoteDescription,g=b.addIceCandidate;b.createOffer=function(a,b){var d=arguments.length>=2?arguments[2]:arguments[0],e=c.apply(this,[d]);return b?(e.then(a,b),Promise.resolve()):e},b.createAnswer=function(a,b){var c=arguments.length>=2?arguments[2]:arguments[0],e=d.apply(this,[c]);return b?(e.then(a,b),Promise.resolve()):e};var h=function(a,b,c){var d=e.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d};b.setLocalDescription=h,h=function(a,b,c){var d=f.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.setRemoteDescription=h,h=function(a,b,c){var d=g.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.addIceCandidate=h}},shimGetUserMedia:function(a){var b=a&&a.navigator;b.getUserMedia||(b.webkitGetUserMedia?b.getUserMedia=b.webkitGetUserMedia.bind(b):b.mediaDevices&&b.mediaDevices.getUserMedia&&(b.getUserMedia=function(a,c,d){b.mediaDevices.getUserMedia(a).then(c,d)}.bind(b)))},shimRTCIceServerUrls:function(a){var b=a.RTCPeerConnection;a.RTCPeerConnection=function(a,c){if(a&&a.iceServers){for(var e=[],f=0;f<a.iceServers.length;f++){var g=a.iceServers[f];!g.hasOwnProperty("urls")&&g.hasOwnProperty("url")?(d.deprecated("RTCIceServer.url","RTCIceServer.urls"),g=JSON.parse(JSON.stringify(g)),g.urls=g.url,delete g.url,e.push(g)):e.push(a.iceServers[f])}a.iceServers=e}return new b(a,c)},a.RTCPeerConnection.prototype=b.prototype,"generateCertificate"in a.RTCPeerConnection&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return b.generateCertificate}})},shimTrackEventTransceiver:function(a){"object"==typeof a&&a.RTCPeerConnection&&"receiver"in a.RTCTrackEvent.prototype&&!a.RTCTransceiver&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(a){var b=a.RTCPeerConnection.prototype.createOffer;a.RTCPeerConnection.prototype.createOffer=function(a){var c=this;if(a){var d=c.getTransceivers().find(function(a){return a.sender.track&&"audio"===a.sender.track.kind});a.offerToReceiveAudio===!1&&d?"sendrecv"===d.direction?d.setDirection("sendonly"):"recvonly"===d.direction&&d.setDirection("inactive"):a.offerToReceiveAudio!==!0||d||c.addTransceiver("audio");var e=c.getTransceivers().find(function(a){return a.sender.track&&"video"===a.sender.track.kind});a.offerToReceiveVideo===!1&&e?"sendrecv"===e.direction?e.setDirection("sendonly"):"recvonly"===e.direction&&e.setDirection("inactive"):a.offerToReceiveVideo!==!0||e||c.addTransceiver("video")}return b.apply(c,arguments)}}};b.exports={shimCallbacksAPI:e.shimCallbacksAPI,shimLocalStreamsAPI:e.shimLocalStreamsAPI,shimRemoteStreamsAPI:e.shimRemoteStreamsAPI,shimGetUserMedia:e.shimGetUserMedia,shimRTCIceServerUrls:e.shimRTCIceServerUrls,shimTrackEventTransceiver:e.shimTrackEventTransceiver,shimCreateOfferLegacy:e.shimCreateOfferLegacy}},{"../utils":13}],13:[function(a,b,c){"use strict";var d=!0,e=!0,f={disableLog:function(a){return"boolean"!=typeof a?new Error("Argument type: "+typeof a+". Please use a boolean."):(d=a,a?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(a){return"boolean"!=typeof a?new Error("Argument type: "+typeof a+". Please use a boolean."):(e=!a,"adapter.js deprecation warnings "+(a?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(d)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(a,b){e&&console.warn(a+" is deprecated, please use "+b+" instead.")},extractVersion:function(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)},detectBrowser:function(a){var b=a&&a.navigator,c={};if(c.browser=null,c.version=null,"undefined"==typeof a||!a.navigator)return c.browser="Not a browser.",c;if(b.mozGetUserMedia)c.browser="firefox",c.version=this.extractVersion(b.userAgent,/Firefox\/(\d+)\./,1);else if(b.webkitGetUserMedia)if(a.webkitRTCPeerConnection)c.browser="chrome",c.version=this.extractVersion(b.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!b.userAgent.match(/Version\/(\d+).(\d+)/))return c.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",c;c.browser="safari",c.version=this.extractVersion(b.userAgent,/AppleWebKit\/(\d+)\./,1)}else if(b.mediaDevices&&b.userAgent.match(/Edge\/(\d+).(\d+)$/))c.browser="edge",c.version=this.extractVersion(b.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!b.mediaDevices||!b.userAgent.match(/AppleWebKit\/(\d+)\./))return c.browser="Not a supported browser.",c;c.browser="safari",c.version=this.extractVersion(b.userAgent,/AppleWebKit\/(\d+)\./,1)}return c}};b.exports={log:f.log,deprecated:f.deprecated,disableLog:f.disableLog,disableWarnings:f.disableWarnings,extractVersion:f.extractVersion,shimCreateObjectURL:f.shimCreateObjectURL,detectBrowser:f.detectBrowser.bind(f)}},{}]},{},[3])(3)}),AhoySipCall.prototype.destroyPeerConnection=function(){var a=this;if(a.pc){a.pc.oniceconnectionstatechange=null;try{a.pc.close()}catch(b){}a.pc=null}},AhoySipCall.prototype.destroy=function(){var a=this;a.destroyPeerConnection(),a.client.removeCall(a.uuid),a.sip=null,a.localStream=null,a.remoteStream=null,a.delegate=null,a.uuid=null},AhoySipCall.prototype.handleWebRtc=function(a,b){var c=this;if(a.sessionReject)c.delegate.callFailed&&c.delegate.callFailed(c,a.sessionReject.reason),c.destroy();else if(a.sessionAcknowledge)c.delegate.callIsRinging&&c.delegate.callIsRinging(c);else if(a.sessionCancel)c.delegate.callCanceled?c.delegate.callCanceled(c):c.delegate.callTerminated&&c.delegate.callTerminated(c),c.destroy();else if(a.sessionTerminate)c.delegate.callTerminated&&c.delegate.callTerminated(c),c.destroy();else if(a.sessionConfirm)a.sessionConfirm.address!==c.client.subAddress&&(c.delegate.callTerminated&&c.delegate.callTerminated(c),c.destroy());else if(a.sessionProgress)a.sessionProgress.sdp&&(c.remoteDescription=new RTCSessionDescription({type:"answer",sdp:a.sessionProgress.sdp}),c.pc.setRemoteDescription(c.remoteDescription,function(){c.delegate.callIsProgressing&&c.delegate.callIsProgressing(c)},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)}));else if(a.sessionAnswer){if(c.isAnswered=!0,a.sessionAnswer.candidates){var d=a.sessionAnswer.candidates;d&&d.length&&d.forEach(function(a){try{var b=new RTCIceCandidate(a);call.remoteIceCandidates.push(b)}catch(c){}})}a.sessionAnswer.sdp?(c.remoteDescription=new RTCSessionDescription({type:"answer",sdp:a.sessionAnswer.sdp}),c.pc.setRemoteDescription(c.remoteDescription,function(){c.remoteIceCandidates.forEach(function(a){c.pc.addIceCandidate(a)}),c.remoteIceCandidates=[],!c.isAnswered&&c.delegate.callAnswered&&c.delegate.callAnswered(c)},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)})):!c.isAnswered&&c.delegate.callAnswered&&c.delegate.callAnswered(c)}else a.sessionOffer&&a.sessionOffer.sdp&&(c.destroyPeerConnection(),c.pc=new RTCPeerConnection(c.pc_config),c.localStream&&c.pc.addStream(c.localStream),c.audioCodec&&(a.sessionOffer.sdp=AhoySdpForceAudioCodec(a.sessionOffer.sdp,c.audioCodec)),c.remoteDescription=new RTCSessionDescription({type:"offer",sdp:a.sessionOffer.sdp}),c.pc.setRemoteDescription(c.remoteDescription,function(){c.pc.createAnswer(function(a){c.pc.setLocalDescription(a,function(){c.localDescription=a,c.sendSessionAnswer()},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)})},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)})},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)}))},AhoySipCall.prototype.sendSessionOffer=function(){var a=this,b={calledPartyNumber:a.calledParty.number,callingPartyNumber:a.callingParty.number};void 0!==a.callingParty.name&&(b.callingPartyName=a.callingParty.name),a.sip.registrationId?b.registrationId=a.sip.registrationId:(b.hostname=a.sip.hostname,b.port=a.sip.port?a.sip.port:5060,b.username=a.sip.username,b.password=a.sip.password,void 0!==a.sip.proxyUrl&&(b.proxyUrl=a.sip.proxyUrl));var c=a.localDescription.sdp;a.isOnHold&&(c=c.replace("a=recvonly","a=sendonly"));var d={sessionOffer:{sdp:c,sip:b,uuid:a.uuid}};a.client.sendWebRtcRequest(d,a.uuid,a.peerAddress),b.password=null,a.sip.password=null},AhoySipCall.prototype.sendSessionAnswer=function(a){var b=this,c={sessionAnswer:{sdp:b.localDescription.sdp,candidates:a,uuid:b.uuid}};b.client.sendWebRtcResponse(c,b.peerAddress)},AhoySipCall.prototype.startCall=function(){var a=this;if(console.log("AhoySipCall.startCall: uuid "+a.uuid),a.isOutgoing=!0,a.turn&&a.turn.urls){var b=[];a.turn.urls.forEach(function(c){b.push({url:c,urls:c,username:a.turn.username,credential:a.turn.credential})}),b.length>0&&(a.pc_config={iceServers:b})}a.pc=new RTCPeerConnection(a.pc_config),a.localStream&&a.pc.addStream(a.localStream),a.pc.oniceconnectionstatechange=function(b){var c=b;b.target&&b.target.iceConnectionState&&(c=b.target.iceConnectionState),console.log("iceConnectionState: "+c),"connected"===c?a.delegate.establishedConnection&&a.delegate.establishedConnection(a):"failed"===c?(a.call.delegate.callFailed&&a.delegate.callFailed(a,"establishing secure connecton failed"),a.terminate()):"disconnected"!==c&&"closed"!==c||(a.delegate.callTerminated&&a.delegate.callTerminated(a),a.terminate())},a.pc.onaddstream=function(b){a.remoteStream=b.stream,a.remoteMedia.srcObject=a.remoteStream},a.pc.createOffer(function(b){a.audioCodec&&(b.sdp=AhoySdpForceAudioCodec(b.sdp,a.audioCodec)),a.pc.setLocalDescription(b,function(){a.localDescription=b,a.sendSessionOffer()},function(b){a.delegate.callFailed&&a.delegate.callFailed(a,b)})},function(b){a.delegate.callFailed&&a.delegate.callFailed(a,b)},a.constraints)},AhoySipCall.prototype.setDelegate=function(a){var b=this;b.delegate=a},AhoySipCall.prototype.acknowledge=function(){var a=this,b={sessionAcknowledge:{uuid:a.uuid}};a.client.sendWebRtcResponse(b,a.peerAddress)},AhoySipCall.prototype.reject=function(a){var b=this,c={sessionReject:{reason:a?a:"busy",uuid:b.uuid}};b.client.sendWebRtcResponse(c,b.peerAddress),b.destroy()},AhoySipCall.prototype.terminate=function(){var a=this,b=null;if(a.isAnswered)b={sessionTerminate:{uuid:a.uuid}};else{if(!a.isOutgoing)return a.reject();b={sessionCancel:{uuid:a.uuid}}}a.client.sendWebRtcResponse(b,a.peerAddress),a.destroy()},AhoySipCall.prototype.sendDTMF=function(a,b,c){var d=this;if(b||(b=150),c||(c=100),d.pc&&d.localStream&&void 0!==d.pc.createDTMFSender){if(void 0===d.dtmfSender){var e=d.localStream.getAudioTracks();e&&e.length&&(d.dtmfSender=d.pc.createDTMFSender(e[0]))}d.dtmfSender&&(70>b&&(b=70),b>6e3&&(b=6e3),50>c&&(c=50),d.dtmfSender.insertDTMF(a,b,c))}},AhoySipCall.prototype.directConnect=function(a,b,c,d){var e=this,f=d.split("@");if(!f||2!=f.length)return console.log("cannot directConnect with xAhoyId: "+d),e.answer(a,b,c);e.client.removeCall(e.uuid),e.destroyPeerConnection();var g=f[0];if(e.peerAddress=f[1],e.uuid=e.client.generateUuid(),e.client.addCall(e.uuid,e),e.localStream=b,e.remoteMedia=c,a.audioCodec?e.audioCodec=a.audioCodec.toLowerCase():e.audioCodec=null,e.isOutgoing=!0,e.turn&&e.turn.urls){var h=[];e.turn.urls.forEach(function(a){h.push({url:a,urls:a,username:e.turn.username,credential:e.turn.credential})}),h.length>0&&(e.pc_config={iceServers:h})}e.pc=new RTCPeerConnection(e.pc_config),e.localStream&&e.pc.addStream(e.localStream),e.pc.oniceconnectionstatechange=function(a){var b=a;a.target&&a.target.iceConnectionState&&(b=a.target.iceConnectionState),console.log("iceConnectionState: "+b),"connected"===b?e.delegate.establishedConnection&&e.delegate.establishedConnection(e):"failed"===b?(e.call.delegate.callFailed&&e.delegate.callFailed(e,"establishing secure connecton failed"),e.terminate()):"disconnected"!==b&&"closed"!==b||(e.delegate.callTerminated&&e.delegate.callTerminated(e),e.terminate())},e.pc.onaddstream=function(a){e.remoteStream=a.stream,e.remoteMedia.srcObject=e.remoteStream};var i=[];e.pc.onicecandidate=function(a){if(a&&a.candidate&&a.candidate.candidate){var b=a.candidate,c={candidate:b.candidate};void 0!=b.sdpMid&&(c.sdpMid=b.sdpMid),void 0!=b.sdpMLineIndex&&(c.sdpMLineIndex=b.sdpMLineIndex),i.push(c)}else if(e.localDescription){var d={sessionOffer:{sdp:e.localDescription.sdp,candidates:i,uuid:e.uuid,replacesUuid:g}};e.client.sendWebRtcRequest(d,e.uuid,e.peerAddress)}},e.pc.createOffer(function(a){e.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,e.audioCodec)),e.pc.setLocalDescription(a,function(){e.localDescription=a},function(a){e.delegate.callFailed&&e.delegate.callFailed(e,a)})},function(a){e.delegate.callFailed&&e.delegate.callFailed(e,a)})},AhoySipCall.prototype.directAnswer=function(a,b,c){var d=this;if(!d.isAnswered){if(d.localStream=b,d.remoteMedia=c,d.isAnswered=!0,a.audioCodec?d.audioCodec=a.audioCodec.toLowerCase():d.audioCodec=null,d.turn&&d.turn.urls){var e=[];d.turn.urls.forEach(function(a){e.push({url:a,urls:a,username:d.turn.username,credential:d.turn.credential})}),e.length>0&&(d.pc_config={iceServers:e})}d.pc=new RTCPeerConnection(d.pc_config),d.pc=new RTCPeerConnection(d.pc_config),d.localStream&&d.pc.addStream(d.localStream),d.pc.oniceconnectionstatechange=function(a){var b=a;a.target&&a.target.iceConnectionState&&(b=a.target.iceConnectionState),console.log("iceConnectionState: "+b),"connected"===b?d.delegate.establishedConnection&&d.delegate.establishedConnection(d):"failed"===b?(d.call.delegate.callFailed&&d.delegate.callFailed(d,"establishing secure connecton failed"),d.terminate()):"disconnected"!==b&&"closed"!==b||(d.delegate.callTerminated&&d.delegate.callTerminated(d),d.terminate())};var f=[];d.pc.onicecandidate=function(a){if(a&&a.candidate&&a.candidate.candidate){var b=a.candidate,c={candidate:b.candidate};void 0!=b.sdpMid&&(c.sdpMid=b.sdpMid),void 0!=b.sdpMLineIndex&&(c.sdpMLineIndex=b.sdpMLineIndex),f.push(c)}else d.localDescription&&d.sendSessionAnswer(f)},d.pc.onaddstream=function(a){d.remoteStream=a.stream,d.remoteMedia.srcObject=d.remoteStream},d.remoteDescription&&d.pc.setRemoteDescription(d.remoteDescription,function(){d.remoteDescription=null,d.remoteIceCandidates.forEach(function(a){d.pc.addIceCandidate(a)}),d.remoteIceCandidates=[],d.pc.createAnswer(function(a){d.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,d.audioCodec)),d.pc.setLocalDescription(a,function(){d.localDescription=a},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject()})},function(a){console.log(a),d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})}},AhoySipCall.prototype.answer=function(a,b,c){var d=this;if(!d.isAnswered){if(a.p2p===!0&&d.sip.xAhoyId)return d.directConnect(a,b,c,d.sip.xAhoyId);if(d.localStream=b,d.remoteMedia=c,d.isAnswered=!0,a.audioCodec?d.audioCodec=a.audioCodec.toLowerCase():d.audioCodec=null,d.turn&&d.turn.urls){var e=[];d.turn.urls.forEach(function(a){e.push({url:a,urls:a,username:d.turn.username,credential:d.turn.credential})}),e.length>0&&(d.pc_config={iceServers:e})}d.pc=new RTCPeerConnection(d.pc_config),d.localStream&&d.pc.addStream(d.localStream),d.pc.oniceconnectionstatechange=function(a){var b=a;a.target&&a.target.iceConnectionState&&(b=a.target.iceConnectionState),console.log("iceConnectionState: "+b),"connected"===b?d.delegate.establishedConnection&&d.delegate.establishedConnection(d):"failed"===b?(d.call.delegate.callFailed&&d.delegate.callFailed(d,"establishing secure connecton failed"),d.terminate()):"disconnected"!==b&&"closed"!==b||(d.delegate.callTerminated&&d.delegate.callTerminated(d),d.terminate())},d.pc.onaddstream=function(a){d.remoteStream=a.stream,d.remoteMedia.srcObject=d.remoteStream},d.remoteDescription&&(d.audioCodec&&(d.remoteDescription.sdp=AhoySdpForceAudioCodec(d.remoteDescription.sdp,d.audioCodec),d.remoteDescription=new RTCSessionDescription({type:"offer",sdp:d.remoteDescription.sdp})),d.pc.setRemoteDescription(d.remoteDescription,function(){d.remoteDescription=null,d.pc.createAnswer(function(a){d.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,d.audioCodec)),d.pc.setLocalDescription(a,function(){d.localDescription=a,d.sendSessionAnswer()},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject()})},function(a){console.log(a),d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")}))}},AhoySipCall.prototype.hold=function(a){var b=this,c=!1,d=!1;b.isOnHold=!0,b.localStream&&b.localStream.getAudioTracks().length>0&&(c=!0),b.localStream&&b.localStream.getVideoTracks().length>0&&(d=!0);var e={offerToReceiveAudio:c,offerToReceiveVideo:d};if(b.destroyPeerConnection(),b.turn&&b.turn.urls){var f=[];b.turn.urls.forEach(function(a){f.push({url:a,urls:a,username:b.turn.username,credential:b.turn.credential})}),f.length>0&&(b.pc_config={iceServers:f})}b.pc=new RTCPeerConnection(b.pc_config),b.pc.createOffer(function(c){b.pc.setLocalDescription(c,function(){b.localDescription=c,b.sendSessionOffer(),a&&a()},function(b){a&&a(b)})},function(b){a&&a(b)},e)},AhoySipCall.prototype.resume=function(a){var b=this;b.isOnHold=!1,b.destroyPeerConnection(),b.startCall()},AhoySipRegistration.prototype.register=function(){var a=this,b=a.client.generateUuid(),c=null;c=a.isRegistered&&a.id?{registerRequest:{registrationId:a.id,uuid:b}}:{registerRequest:{registrar:a.registrar,username:a.username,password:a.password,refresh:a.refresh,useragent:a.useragent,proxyUrl:a.proxyUrl?a.proxyUrl:null,uuid:b}},a.client.sendSipRequest(c,b,function(b){b&&b.registration?(a.isRegistered=!0,a.id=b.registration.id,a.callback(b.error,a)):(a.isRegistered=!1,a.callback("error",a))})},AhoySipRegistration.prototype.unregister=function(){var a=this,b=a.client.generateUuid(),c={unregisterRequest:{registrationId:a.id,uuid:b}};a.client.sendSipRequest(c,b,function(b){a.client.removeSipRegistration(a.id),b&&b.registration?a.callback(b.error,a):a.callback("error",a)})},AhoySipRegistration.prototype.call=function(a,b,c,d){var e=this,f=a.calledParty,g=a.callingParty,h=a.timeout;"string"==typeof f&&(f={number:f}),g?"string"==typeof g&&(g={number:g}):g={number:e.username};var i={audioCodec:a.audioCodec,calledParty:f,callingParty:g,timeout:h},j=new AhoySipCall(null,i,b,c,e.client,d);return j&&(e.client.addCall(j.uuid,j),j.startCall()),j};var RTC2SIP=RTC2SIP||{errorCallback:null,ws:null,generateUuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},send:function(a){var b=this;b.ws&&b.ws.send(JSON.stringify(a))},sendMessage:function(a,b){var c=this,d={message:a,to:b,uuid:c.generateUuid()};c.send({messageRequest:d})},initCallback:null,requests:0,requestCallbacks:{},sipRegistrations:{},calls:{},sendRequest:function(a,b,c,d){var e=this;d&&(e.requestCallbacks[b]=d),e.sendMessage(a,c)},sendSipRequest:function(a,b,c){var d=this;d.sendRequest({sip:a},b,null,c)},sendWebRtcRequest:function(a,b,c){var d=this;d.sendRequest({webrtc:a},b,c)},sendWebRtcResponse:function(a,b){var c=this;c.sendMessage({webrtc:a},b)},handleSip:function(a){var b=this,c=null,d=null,e=null;a.registerResponse&&(c=a.registerResponse.uuid,d=b.requestCallbacks[c],e=a.registerResponse),d?d(e):console.log("no callback for "+JSON.stringify(a))},handleWebRtc:function(a,b){var c=this,d=null,e=null,f=null,g=null;if(a.sessionOffer?(e=a.sessionOffer.uuid,g=a.sessionOffer.sdp,f="sessionOffer"):a.sessionAnswer?(e=a.sessionAnswer.uuid,g=a.sessionAnswer.sdp,f="sessionAnswer"):a.sessionAcknowledge?(e=a.sessionAcknowledge.uuid,f="sessionAcknowledge"):a.sessionProgress?(e=a.sessionProgress.uuid,g=a.sessionProgress.sdp,f="sessionProgress"):a.sessionReject?(e=a.sessionReject.uuid,f="sessionReject"):a.sessionCancel?(e=a.sessionCancel.uuid,f="sessionCancel"):a.sessionTerminate?(e=a.sessionTerminate.uuid,f="sessionTerminate"):a.sessionConfirm&&(e=a.sessionConfirm.uuid,f="sessionConfirm"),!e||!f)return console.log("no uuid "+e+" or messageType "+f),void console.log(a);var h=c.calls[e];if(console.log("< "+f+" uuid "+e+" call "+h),h)h.handleWebRtc(a,b);else{if("sessionOffer"!==f)return;var i=!0,j=Object.keys(c.calls).length;if(0==j||c.isCallWaitingEnabled||a.sessionOffer.replacesUuid)if(a.sessionOffer.sip&&a.sessionOffer.sip.registrationId){if(d=a.sessionOffer.sip.registrationId,d&&c.sipRegistrations[d]){var k="anonymous",l=null,m="unknown";a.sessionOffer.sip.callingPartyNumber&&(k=a.sessionOffer.sip.callingPartyNumber),l=a.sessionOffer.sip.callingPartyName?a.sessionOffer.sip.callingPartyName:k,a.sessionOffer.sip.calledPartyNumber&&(m=a.sessionOffer.sip.calledPartyNumber);var n=c.sipRegistrations[d];if(n){console.log("incoming SIP call for registration "+n.id);var o={peerAddress:b,sip:a.sessionOffer.sip,calledParty:{number:m},callingParty:{number:k,name:l}},h=new AhoySipCall(e,o,null,null,c,null);g&&(h.remoteDescription=new RTCSessionDescription({type:"offer",sdp:g})),c.calls[h.uuid]=h,n.delegate.callReceived(h),i=!1}}}else if(a.sessionOffer.replacesUuid){var h=c.calls[a.sessionOffer.replacesUuid];if(h){var p=h.localStream,q=h.remoteMedia,r=h.delegate;h.terminate();var o={peerAddress:b};if(h=new AhoySipCall(e,o,null,null,c,r),g&&(h.remoteDescription=new RTCSessionDescription({type:"offer",sdp:g})),a.sessionOffer.candidates){var s=a.sessionOffer.candidates;s&&s.length&&s.forEach(function(a){try{var b=new RTCIceCandidate(a);h.remoteIceCandidates.push(b)}catch(c){}})}c.calls[h.uuid]=h,h.directAnswer({},p,q),i=!1}}i&&c.sendWebRtcResponse({sessionReject:{uuid:e,reason:"busy"}},b)}},handleMessageEvent:function(a){var b=this;a.message.webrtc&&b.handleWebRtc(a.message.webrtc,a.from),a.message.sip&&b.handleSip(a.message.sip)},init:function(a,b){var c=this;c.isCallWaitingEnabled=void 0!==a.enableCallWaiting?a.enableCallWaiting:!1,c.errorCallback=b,c.initCallback=function(a){c.initCallback=null,b(a)},a.transport?(c.send=function(b){a.transport.send(b)},a.transport.onmessage=function(a){a&&(a.messageEvent?c.handleMessageEvent(a.messageEvent):a.identityResponse&&(a.identityResponse.success?(c.address=a.identityResponse.address,c.subAddress=c.address+"_"+a.identityResponse.session,c.initCallback&&c.initCallback()):c.initCallbacK("failed")))},a.transport.onerror=function(a){console.log(a),b("rtc2sip_init_failed")},a.transport.onclose=function(){console.log("rtc2sip_connection_lost"),b("rtc2sip_connection_lost")},c.send({identityRequest:{uuid:c.generateUuid()}})):(c.wsUrl=a.wsUrl,c.ws||(c.ws=new WebSocket(c.wsUrl,"ahoyrtc-protocol"),c.ws.onopen=function(){c.send({identityRequest:{uuid:c.generateUuid()}})},c.ws.onclose=function(){c.ws=null,console.log("rtc2sip_connection_lost"),b("rtc2sip_connection_lost")},c.ws.onerror=function(a){c.ws=null,console.log(a),b("rtc2sip_init_failed")},c.ws.onmessage=function(a){var b=null;try{b=JSON.parse(a.data)}catch(d){console.log(d)}b&&(b.messageEvent?c.handleMessageEvent(b.messageEvent):b.identityResponse&&(b.identityResponse.success?(c.address=b.identityResponse.address,c.subAddress=c.address+"_"+b.identityResponse.session,c.initCallback&&c.initCallback()):c.initCallbacK("failed")))}))},register:function(a,b,c){var d=this,e=function(a,b){!a&&b?d.sipRegistrations[b.id]=b:void 0!==d.sipRegistrations[b.id]&&delete d.sipRegistrations[b.id],c(a,b)};new AhoySipRegistration(a,d,b,e)},call:function(a,b,c,d){var e=this,f=a.calledParty,g=a.callingParty,h=a.timeout?a.timeout:-1;"string"==typeof f&&(f={number:f}),g?"string"==typeof g&&(g={number:g}):g={number:"anonymous"};var i={constraints:a.constraints,peerAddress:a.peerAddress,audioCodec:a.audioCodec,sip:a.sip,calledParty:f,callingParty:g,timeout:h},j=new AhoySipCall(null,i,b,c,e,d);return j&&(e.addCall(j.uuid,j),j.startCall()),j},addCall:function(a,b){var c=this;c.calls[a]=b},removeCall:function(a){var b=this;delete b.calls[a]},removeSipRegistration:function(a){var b=this;delete b.sipRegistrationsid[a]},stopMediaStream:function(a){if(a){for(var b=a.getAudioTracks(),c=0;c<b.length;c++)b[c].stop();for(var d=a.getVideoTracks(),c=0;c<d.length;c++)d[c].stop()}},shutdown:function(){var a=this,b=Object.keys(a.calls);b.forEach(function(b){a.calls[b].terminate()}),a.calls={},b=Object.keys(a.sipRegistrations),b.forEach(function(b){a.sipRegistrations[b].unregister()}),a.sipRegisrations={},a.ws&&(a.ws.onerror=null,a.ws.onclose=null,a.ws.close(),a.ws=null)}};
//# sourceMappingURL=rtc2sip.min.js.map