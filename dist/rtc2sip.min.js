function AhoySipCall(a,b,c,d,e,f){var g=this;g.pc=null,g.pc_config=null,g.turn=b&&b.turn||null,g.calledParty=b.calledParty,g.callingParty=b.callingParty,g.timeout=b.timeout,g.sip=b.sip?b.sip:{},g.localStream=c,g.remoteStream=null,g.remoteMedia=d,g.remoteDescription=null,g.remoteIceCandidates=[],g.client=e,g.delegate=f,g.uuid=a||e.generateUuid(),void 0!==b.audioCodec?g.audioCodec=b.audioCodec.toLowerCase():g.audioCodec=null,void 0!==b.peerAddress?g.peerAddress=b.peerAddress:g.peerAddress=null,void 0!==b.constraints?g.constraints=b.constraints:g.constraints=null,g.isOutgoing=!1,g.isAnswered=!1}function AhoySdpForceAudioCodec(a,b){function c(a){var b=null,c=a.split(" ");return c&&c.length&&(c=c[0].split(":"),c&&c.length>1&&(b=c[1])),b}function d(a){var b=a.split(" ");return b&&b.length?b[1].toLowerCase():null}var e=a.split("\r\n"),f=null,g=[],h=[];if(e.forEach(function(a){-1!==a.toLowerCase().indexOf("a=rtpmap:")&&(-1!==a.toLowerCase().indexOf(b)?f=c(a):"telephone-event/8000"===d(a)&&g.push(c(a)))}),!f)return console.log("AhoySdpForceAudioCodec: cannot force audioCodec "+b+" because it is not contained in the SDP"),a;var i=!1;return e.forEach(function(a){if(-1!==a.indexOf("m=audio")){i=!0;var b=a.split(" ");if(b&&b.length>3){var e=b[0]+" "+b[1]+" "+b[2]+" "+f;g.length&&(e+=" "+g.join(" ")),h.push(e)}else h.push(a)}else-1!==a.indexOf("m=")?(i=!1,h.push(a)):i?-1!==a.indexOf("a=rtpmap:")&&c(a)!==f?"telephone-event/8000"===d(a)&&(g.push(c(a)),h.push(a)):-1!==a.indexOf("a=fmtp:")&&c(a)!==f||-1!==a.indexOf("a=rtcp-fb:")&&c(a)!==f||h.push(a):h.push(a)}),h.join("\r\n")}function AhoySipRegistration(a,b,c,d){var e=this;e.username=a.username,e.password=a.password,e.registrar={hostname:a.registrar.hostname,port:a.registrar.port||5060},e.refresh=a.refresh||300,e.proxyUrl=a.proxyUrl,e.useragent=a.useragent,e.callback=d,e.client=b,e.delegate=c||function(a){a.reject()},e.register()}var AdapterJS=AdapterJS||{};if(AdapterJS.options={},AdapterJS.VERSION="0.10.6",AdapterJS.onwebrtcready=AdapterJS.onwebrtcready||function(a){},AdapterJS.WebRTCPlugin=AdapterJS.WebRTCPlugin||{},AdapterJS.WebRTCPlugin.pluginInfo={prefix:"Tem",plugName:"TemWebRTCPlugin",pluginId:"plugin0",type:"application/x-temwebrtcplugin",onload:"__TemWebRTCReady0",portalLink:"http://skylink.io/plugin/",downloadLink:null,companyName:"Temasys"},navigator.platform.match(/^Mac/i)?AdapterJS.WebRTCPlugin.pluginInfo.downloadLink="http://bit.ly/1n77hco":navigator.platform.match(/^Win/i)&&(AdapterJS.WebRTCPlugin.pluginInfo.downloadLink="http://bit.ly/1kkS4FN"),AdapterJS.WebRTCPlugin.pageId=Math.random().toString(36).slice(2),AdapterJS.WebRTCPlugin.plugin=null,AdapterJS.WebRTCPlugin.setLogLevel=null,AdapterJS.WebRTCPlugin.defineWebRTCInterface=null,AdapterJS.WebRTCPlugin.isPluginInstalled=null,AdapterJS.WebRTCPlugin.pluginInjectionInterval=null,AdapterJS.WebRTCPlugin.injectPlugin=null,AdapterJS.WebRTCPlugin.PLUGIN_STATES={NONE:0,INITIALIZING:1,INJECTING:2,INJECTED:3,READY:4},AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.NONE,AdapterJS.onwebrtcreadyDone=!1,AdapterJS.WebRTCPlugin.PLUGIN_LOG_LEVELS={NONE:"NONE",ERROR:"ERROR",WARNING:"WARNING",INFO:"INFO",VERBOSE:"VERBOSE",SENSITIVE:"SENSITIVE"},AdapterJS.WebRTCPlugin.WaitForPluginReady=null,AdapterJS.WebRTCPlugin.callWhenPluginReady=null,__TemWebRTCReady0=function(){"complete"===document.readyState?(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY,AdapterJS.maybeThroughWebRTCReady()):AdapterJS.WebRTCPlugin.documentReadyInterval=setInterval(function(){"complete"===document.readyState&&(clearInterval(AdapterJS.WebRTCPlugin.documentReadyInterval),AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY,AdapterJS.maybeThroughWebRTCReady())},100)},AdapterJS.maybeThroughWebRTCReady=function(){AdapterJS.onwebrtcreadyDone||(AdapterJS.onwebrtcreadyDone=!0,"function"==typeof AdapterJS.onwebrtcready&&AdapterJS.onwebrtcready(null!==AdapterJS.WebRTCPlugin.plugin))},AdapterJS._iceConnectionStates={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},AdapterJS._iceConnectionFiredStates=[],AdapterJS.isDefined=null,AdapterJS.parseWebrtcDetectedBrowser=function(){var a,b=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(b[1])?(a=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],webrtcDetectedBrowser="IE",webrtcDetectedVersion=parseInt(a[1]||"0",10)):"Chrome"===b[1]&&(a=navigator.userAgent.match(/\bOPR\/(\d+)/),null!==a&&(webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(a[1],10))),navigator.userAgent.indexOf("Safari")&&("undefined"!=typeof InstallTrigger?webrtcDetectedBrowser="firefox":document.documentMode?webrtcDetectedBrowser="IE":Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0?webrtcDetectedBrowser="safari":window.opera||navigator.userAgent.indexOf(" OPR/")>=0?webrtcDetectedBrowser="opera":window.chrome&&(webrtcDetectedBrowser="chrome")),webrtcDetectedBrowser||(webrtcDetectedVersion=b[1]),!webrtcDetectedVersion)try{b=b[2]?[b[1],b[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(a=navigator.userAgent.match(/version\/(\d+)/i))&&b.splice(1,1,a[1]),webrtcDetectedVersion=parseInt(b[1],10)}catch(c){}},AdapterJS.maybeFixConfiguration=function(a){if(null!==a)for(var b=0;b<a.iceServers.length;b++)a.iceServers[b].hasOwnProperty("urls")&&(a.iceServers[b].url=a.iceServers[b].urls,delete a.iceServers[b].urls)},AdapterJS.addEvent=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a[b]=c},webrtcDetectedType=null,webrtcDetectedDCSupport=null,checkMediaDataChannelSettings=function(a,b,c,d){if("function"==typeof c){var e=!0,f="firefox"===webrtcDetectedBrowser,g="moz"===webrtcDetectedType&&webrtcDetectedVersion>30,h="firefox"===a;if(f&&h||g)try{delete d.mandatory.MozDontOfferDataChannel}catch(i){console.error("Failed deleting MozDontOfferDataChannel"),console.error(i)}else f&&!h&&(d.mandatory.MozDontOfferDataChannel=!0);if(!f)for(var j in d.mandatory)d.mandatory.hasOwnProperty(j)&&-1!==j.indexOf("Moz")&&delete d.mandatory[j];!f||h||g||(e=!1),c(e,d)}},checkIceConnectionState=function(a,b,c){return"function"!=typeof c?void console.warn("No callback specified in checkIceConnectionState. Aborted."):(a=a?a:"peer",AdapterJS._iceConnectionFiredStates[a]&&b!==AdapterJS._iceConnectionStates.disconnected&&b!==AdapterJS._iceConnectionStates.failed&&b!==AdapterJS._iceConnectionStates.closed||(AdapterJS._iceConnectionFiredStates[a]=[]),b=AdapterJS._iceConnectionStates[b],void(AdapterJS._iceConnectionFiredStates[a].indexOf(b)<0&&(AdapterJS._iceConnectionFiredStates[a].push(b),b===AdapterJS._iceConnectionStates.connected&&setTimeout(function(){AdapterJS._iceConnectionFiredStates[a].push(AdapterJS._iceConnectionStates.done),c(AdapterJS._iceConnectionStates.done)},1e3),c(b))))},createIceServer=null,createIceServers=null,RTCPeerConnection=null,RTCSessionDescription="function"==typeof RTCSessionDescription?RTCSessionDescription:null,RTCIceCandidate="function"==typeof RTCIceCandidate?RTCIceCandidate:null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,navigator.mozGetUserMedia)webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),webrtcDetectedType="moz",webrtcDetectedDCSupport="SCTP",RTCPeerConnection=function(a,b){return AdapterJS.maybeFixConfiguration(a),new mozRTCPeerConnection(a,b)},RTCSessionDescription=mozRTCSessionDescription,window.RTCSessionDescription=RTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,window.RTCIceCandidate=RTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(a){setTimeout(function(){var b=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];a(b)},0)},createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn"))if(webrtcDetectedVersion<27){var f=a.split("?");1!==f.length&&0!==f[1].indexOf("transport=udp")||(d={url:f[0],credential:c,username:b})}else d={url:a,credential:c,username:b};return d},createIceServers=function(a,b,c){var d=[];for(i=0;i<a.length;i++){var e=createIceServer(a[i],b,c);null!==e&&d.push(e)}return d},attachMediaStream=function(a,b){return a.mozSrcObject=b,null!==b&&a.play(),a},reattachMediaStream=function(a,b){return a.mozSrcObject=b.mozSrcObject,a.play(),a},MediaStreamTrack.getSources=MediaStreamTrack.getSources||function(a){if(!a)throw new TypeError("Failed to execute 'getSources' on 'MediaStreamTrack': 1 argument required, but only 0 present.");return a([])},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]}),AdapterJS.maybeThroughWebRTCReady();else if(navigator.webkitGetUserMedia){webrtcDetectedBrowser="chrome",webrtcDetectedType="webkit",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10);var checkIfOpera=navigator.userAgent.match(/\bOPR\/(\d+)/);null!==checkIfOpera&&(webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(checkIfOpera[1],10)),"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion>=31||"opera"===webrtcDetectedBrowser&&webrtcDetectedVersion>=20?webrtcDetectedDCSupport="SCTP":"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion<30&&webrtcDetectedVersion>24?webrtcDetectedDCSupport="RTP":webrtcDetectedDCSupport="",createIceServer=function(a,b,c){var d=null,e=a.split(":");return 0===e[0].indexOf("stun")?d={url:a}:0===e[0].indexOf("turn")&&(d={url:a,credential:c,username:b}),d},createIceServers=function(a,b,c){var d=[];if(webrtcDetectedVersion>=34)d={urls:a,credential:c,username:b};else for(i=0;i<a.length;i++){var e=createIceServer(a[i],b,c);null!==e&&d.push(e)}return d},RTCPeerConnection=function(a,b){return webrtcDetectedVersion<34&&AdapterJS.maybeFixConfiguration(a),new webkitRTCPeerConnection(a,b)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(a,b){return"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=null===b?"":URL.createObjectURL(b):console.log("Error attaching stream to element."),a},reattachMediaStream=function(a,b){return a.src=b.src,a},AdapterJS.maybeThroughWebRTCReady()}else"object"==typeof console&&"function"==typeof console.log||(console={}||console,console.log=function(a){},console.info=function(a){},console.error=function(a){},console.dir=function(a){},console.exception=function(a){},console.trace=function(a){},console.warn=function(a){},console.count=function(a){},console.debug=function(a){},console.count=function(a){},console.time=function(a){},console.timeEnd=function(a){},console.group=function(a){},console.groupCollapsed=function(a){},console.groupEnd=function(a){}),webrtcDetectedType="plugin",webrtcDetectedDCSupport="plugin",AdapterJS.parseWebrtcDetectedBrowser(),isIE="IE"===webrtcDetectedBrowser,AdapterJS.WebRTCPlugin.WaitForPluginReady=function(){for(;AdapterJS.WebRTCPlugin.pluginState!==AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY;);},AdapterJS.WebRTCPlugin.callWhenPluginReady=function(a){if(AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY)a();else var b=setInterval(function(){AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY&&(clearInterval(b),a())},100)},AdapterJS.WebRTCPlugin.setLogLevel=function(a){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.setLogLevel(a)})},AdapterJS.WebRTCPlugin.injectPlugin=function(){if("complete"===document.readyState&&AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING){if(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTING,"IE"===webrtcDetectedBrowser&&webrtcDetectedVersion<=10){var a=document.createDocumentFragment();for(AdapterJS.WebRTCPlugin.plugin=document.createElement("div"),AdapterJS.WebRTCPlugin.plugin.innerHTML='<object id="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'" width="1" height="1"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" /> <param name="windowless" value="false" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'" />'+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+"</object>";AdapterJS.WebRTCPlugin.plugin.firstChild;)a.appendChild(AdapterJS.WebRTCPlugin.plugin.firstChild);document.body.appendChild(a),AdapterJS.WebRTCPlugin.plugin=document.getElementById(AdapterJS.WebRTCPlugin.pluginInfo.pluginId)}else AdapterJS.WebRTCPlugin.plugin=document.createElement("object"),AdapterJS.WebRTCPlugin.plugin.id=AdapterJS.WebRTCPlugin.pluginInfo.pluginId,isIE?(AdapterJS.WebRTCPlugin.plugin.width="1px",AdapterJS.WebRTCPlugin.plugin.height="1px"):(AdapterJS.WebRTCPlugin.plugin.width="0px",AdapterJS.WebRTCPlugin.plugin.height="0px"),AdapterJS.WebRTCPlugin.plugin.type=AdapterJS.WebRTCPlugin.pluginInfo.type,AdapterJS.WebRTCPlugin.plugin.innerHTML='<param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'"><param name="windowless" value="false" /> '+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+'<param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'">',document.body.appendChild(AdapterJS.WebRTCPlugin.plugin);AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTED}},AdapterJS.WebRTCPlugin.isPluginInstalled=function(a,b,c,d){if(isIE){try{new ActiveXObject(a+"."+b)}catch(e){return void d()}c()}else{for(var f=navigator.plugins,g=0;g<f.length;g++)if(f[g].name.indexOf(b)>=0)return void c();d()}},AdapterJS.WebRTCPlugin.defineWebRTCInterface=function(){AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING,AdapterJS.isDefined=function(a){return null!==a&&void 0!==a},createIceServer=function(a,b,c){var d=null,e=a.split(":");return 0===e[0].indexOf("stun")?d={url:a,hasCredentials:!1}:0===e[0].indexOf("turn")&&(d={url:a,hasCredentials:!0,credential:c,username:b}),d},createIceServers=function(a,b,c){for(var d=[],e=0;e<a.length;++e)d.push(createIceServer(a[e],b,c));return d},RTCSessionDescription=function(a){return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructSessionDescription(a.type,a.sdp)},RTCPeerConnection=function(a,b){var c=null;if(a){c=a.iceServers;for(var d=0;d<c.length;d++)c[d].urls&&!c[d].url&&(c[d].url=c[d].urls),c[d].hasCredentials=AdapterJS.isDefined(c[d].username)&&AdapterJS.isDefined(c[d].credential)}var e=b&&b.mandatory?b.mandatory:null,f=b&&b.optional?b.optional:null;return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.PeerConnection(AdapterJS.WebRTCPlugin.pageId,c,e,f)},MediaStreamTrack={},MediaStreamTrack.getSources=function(a){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.GetSources(a)})},getUserMedia=function(a,b,c){a.audio||(a.audio=!1),AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.getUserMedia(a,b,c)})},navigator.getUserMedia=getUserMedia,attachMediaStream=function(a,b){if(a&&a.parentNode){var c;if(null===b?c="":(b.enableSoundTracks(!0),c=b.id),"audio"!==a.nodeName.toLowerCase()){var d=0===a.id.length?Math.random().toString(36).slice(2):a.id;if(a.isWebRTCPlugin&&a.isWebRTCPlugin()){for(var e=a.children,f=0;f!==e.length;++f)if("streamId"===e[f].name){e[f].value=c;break}a.setStreamId(c)}else{var g=document.createDocumentFragment(),h=document.createElement("div"),i="";for(a.className?i='class="'+a.className+'" ':a.attributes&&a.attributes["class"]&&(i='class="'+a.attributes["class"].value+'" '),h.innerHTML='<object id="'+d+'" '+i+'type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'"><param name="pluginId" value="'+d+'" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="windowless" value="true" /> <param name="streamId" value="'+c+'" /> </object>';h.firstChild;)g.appendChild(h.firstChild);var j="",k="";if(a.getBoundingClientRect){var l=a.getBoundingClientRect();k=l.width+"px",j=l.height+"px"}else a.width&&(k=a.width,j=a.height);a.parentNode.insertBefore(g,a),g=document.getElementById(d),g.width=k,g.height=j,a.parentNode.removeChild(a)}var m=document.getElementById(d);return m.onplaying=a.onplaying?a.onplaying:function(a){},isIE&&(m.attachEvent("onplaying",m.onplaying),m.onclick=a.onclick?a.onclick:function(a){},m._TemOnClick=function(a){var b={srcElement:document.getElementById(a)};m.onclick(b)}),m}return a}},reattachMediaStream=function(a,b){for(var c=null,d=b.children,e=0;e!==d.length;++e)if("streamId"===d[e].name){AdapterJS.WebRTCPlugin.WaitForPluginReady(),c=AdapterJS.WebRTCPlugin.plugin.getStreamWithId(AdapterJS.WebRTCPlugin.pageId,d[e].value);break}return null!==c?attachMediaStream(a,c):void console.log("Could not find the stream associated with this element")},RTCIceCandidate=function(a){return a.sdpMid||(a.sdpMid=""),AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructIceCandidate(a.sdpMid,a.sdpMLineIndex,a.candidate)},AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.injectPlugin),AdapterJS.WebRTCPlugin.injectPlugin()},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb=AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb||function(){AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv),AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv()},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv=function(){if(!AdapterJS.options.hidePluginInstallPrompt){var a=AdapterJS.WebRTCPlugin.pluginInfo.downloadLink;if(a){var b;b=AdapterJS.WebRTCPlugin.pluginInfo.portalLink?'This website requires you to install the  <a href="'+AdapterJS.WebRTCPlugin.pluginInfo.portalLink+'" target="_blank">'+AdapterJS.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin</a> to work on this browser.":"This website requires you to install a WebRTC-enabling plugin to work on this browser.",AdapterJS.WebRTCPlugin.renderNotificationBar(b,"Install Now",a)}else navigator.platform.match(/^iPad/i)}},AdapterJS.WebRTCPlugin.renderNotificationBar=function(a,b,d){if("complete"===document.readyState){var e=window,f=document.createElement("iframe");f.style.position="fixed",f.style.top="-41px",f.style.left=0,f.style.right=0,f.style.width="100%",f.style.height="40px",f.style.backgroundColor="#ffffe1",f.style.border="none",f.style.borderBottom="1px solid #888888",f.style.zIndex="9999999","string"==typeof f.style.webkitTransition?f.style.webkitTransition="all .5s ease-out":"string"==typeof f.style.transition&&(f.style.transition="all .5s ease-out"),document.body.appendChild(f),c=f.contentWindow?f.contentWindow:f.contentDocument.document?f.contentDocument.document:f.contentDocument,c.document.open(),c.document.write('<span style="font-family: Helvetica, Arial,sans-serif; font-size: .9rem; padding: 7px; vertical-align: middle; cursor: default;">'+a+"</span>"),b&&d?(c.document.write('<button id="okay">'+b+"</button><button>Cancel</button>"),c.document.close(),AdapterJS.addEvent(c.document.getElementById("okay"),"click",function(a){window.open(d,"_top"),a.preventDefault();try{event.cancelBubble=!0}catch(b){}})):c.document.close(),AdapterJS.addEvent(c.document,"click",function(){e.document.body.removeChild(f)}),setTimeout(function(){"string"==typeof f.style.webkitTransform?f.style.webkitTransform="translateY(40px)":"string"==typeof f.style.transform?f.style.transform="translateY(40px)":f.style.top="0px"},300)}},AdapterJS.WebRTCPlugin.isPluginInstalled(AdapterJS.WebRTCPlugin.pluginInfo.prefix,AdapterJS.WebRTCPlugin.pluginInfo.plugName,AdapterJS.WebRTCPlugin.defineWebRTCInterface,AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb);AhoySipCall.prototype.destroyPeerConnection=function(){var a=this;if(a.pc){a.pc.oniceconnectionstatechange=null;try{a.pc.close()}catch(b){}a.pc=null}},AhoySipCall.prototype.destroy=function(){var a=this;a.destroyPeerConnection(),a.client.removeCall(a.uuid),a.sip=null,a.localStream=null,a.remoteStream=null,a.delegate=null,a.uuid=null},AhoySipCall.prototype.handleWebRtc=function(a,b){var c=this;if(a.sessionReject)c.delegate.callFailed&&c.delegate.callFailed(c,a.sessionReject.reason),c.destroy();else if(a.sessionAcknowledge)c.delegate.callIsRinging&&c.delegate.callIsRinging(c);else if(a.sessionCancel)c.delegate.callCanceled?c.delegate.callCanceled(c):c.delegate.callTerminated&&c.delegate.callTerminated(c),c.destroy();else if(a.sessionTerminate)c.delegate.callTerminated&&c.delegate.callTerminated(c),c.destroy();else if(a.sessionConfirm)a.sessionConfirm.address!==c.client.subAddress&&(c.delegate.callTerminated&&c.delegate.callTerminated(c),c.destroy());else if(a.sessionProgress)a.sessionProgress.sdp&&(c.remoteDescription=new RTCSessionDescription({type:"answer",sdp:a.sessionProgress.sdp}),c.pc.setRemoteDescription(c.remoteDescription,function(){c.delegate.callIsProgressing&&c.delegate.callIsProgressing(c)},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)}));else if(a.sessionAnswer){if(c.isAnswered=!0,a.sessionAnswer.candidates){var d=a.sessionAnswer.candidates;d&&d.length&&d.forEach(function(a){try{var b=new RTCIceCandidate(a);call.remoteIceCandidates.push(b)}catch(c){}})}a.sessionAnswer.sdp?(c.remoteDescription=new RTCSessionDescription({type:"answer",sdp:a.sessionAnswer.sdp}),c.pc.setRemoteDescription(c.remoteDescription,function(){c.remoteIceCandidates.forEach(function(a){c.pc.addIceCandidate(a)}),c.remoteIceCandidates=[],!c.isAnswered&&c.delegate.callAnswered&&c.delegate.callAnswered(c)},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)})):!c.isAnswered&&c.delegate.callAnswered&&c.delegate.callAnswered(c)}else a.sessionOffer&&a.sessionOffer.sdp&&(c.destroyPeerConnection(),c.pc=new RTCPeerConnection(c.pc_config),c.localStream&&c.pc.addStream(c.localStream),c.remoteDescription=new RTCSessionDescription({type:"offer",sdp:a.sessionOffer.sdp}),c.pc.setRemoteDescription(c.remoteDescription,function(){c.pc.createAnswer(function(a){c.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,c.audioCodec)),c.pc.setLocalDescription(a,function(){c.localDescription=a,c.sendSessionAnswer()},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)})},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)})},function(a){c.delegate.callFailed&&c.delegate.callFailed(c,a)}))},AhoySipCall.prototype.sendSessionOffer=function(){var a=this,b={calledPartyNumber:a.calledParty.number,callingPartyNumber:a.callingParty.number};void 0!==a.callingParty.name&&(b.callingPartyName=a.callingParty.name),a.sip.registrationId?b.registrationId=a.sip.registrationId:(b.hostname=a.sip.hostname,b.port=a.sip.port?a.sip.port:5060,b.username=a.sip.username,b.password=a.sip.password,void 0!==a.sip.proxyUrl&&(b.proxyUrl=a.sip.proxyUrl));var c={sessionOffer:{sdp:a.localDescription.sdp,sip:b,uuid:a.uuid}};a.client.sendWebRtcRequest(c,a.uuid,a.peerAddress),b.password=null,a.sip.password=null},AhoySipCall.prototype.sendSessionAnswer=function(a){var b=this,c={sessionAnswer:{sdp:b.localDescription.sdp,candidates:a,uuid:b.uuid}};b.client.sendWebRtcResponse(c,b.peerAddress)},AhoySipCall.prototype.startCall=function(){var a=this;if(console.log("AhoySipCall.startCall: uuid "+a.uuid),a.isOutgoing=!0,a.turn&&a.turn.urls){var b=[];a.turn.urls.forEach(function(c){b.push({url:c,urls:c,username:a.turn.username,credential:a.turn.credential})}),b.length>0&&(a.pc_config={iceServers:b})}a.pc=new RTCPeerConnection(a.pc_config),a.localStream&&a.pc.addStream(a.localStream),a.pc.oniceconnectionstatechange=function(b){var c=b;b.target&&b.target.iceConnectionState&&(c=b.target.iceConnectionState),console.log("iceConnectionState: "+c),"connected"===c?a.delegate.establishedConnection&&a.delegate.establishedConnection(a):"failed"===c?(a.call.delegate.callFailed&&a.delegate.callFailed(a,"establishing secure connecton failed"),a.terminate()):"disconnected"!==c&&"closed"!==c||(a.delegate.callTerminated&&a.delegate.callTerminated(a),a.terminate())},a.pc.onaddstream=function(b){a.remoteStream=b.stream,attachMediaStream(a.remoteMedia,a.remoteStream)},a.pc.createOffer(function(b){a.audioCodec&&(b.sdp=AhoySdpForceAudioCodec(b.sdp,a.audioCodec)),a.pc.setLocalDescription(b,function(){a.localDescription=b,a.sendSessionOffer()},function(b){a.delegate.callFailed&&a.delegate.callFailed(a,b)})},function(b){a.delegate.callFailed&&a.delegate.callFailed(a,b)},a.constraints)},AhoySipCall.prototype.setDelegate=function(a){var b=this;b.delegate=a},AhoySipCall.prototype.acknowledge=function(){var a=this,b={sessionAcknowledge:{uuid:a.uuid}};a.client.sendWebRtcResponse(b,a.peerAddress)},AhoySipCall.prototype.reject=function(a){var b=this,c={sessionReject:{reason:a?a:"busy",uuid:b.uuid}};b.client.sendWebRtcResponse(c,b.peerAddress),b.destroy()},AhoySipCall.prototype.terminate=function(){var a=this,b=null;if(a.isAnswered)b={sessionTerminate:{uuid:a.uuid}};else{if(!a.isOutgoing)return a.reject();b={sessionCancel:{uuid:a.uuid}}}a.client.sendWebRtcResponse(b,a.peerAddress),a.destroy()},AhoySipCall.prototype.directConnect=function(a,b,c,d){var e=this,f=d.split("@");if(!f||2!=f.length)return console.log("cannot directConnect with xAhoyId: "+d),e.answer(a,b,c);e.client.removeCall(e.uuid),e.destroyPeerConnection();var g=f[0];if(e.peerAddress=f[1],e.uuid=e.client.generateUuid(),e.client.addCall(e.uuid,e),e.localStream=b,e.remoteMedia=c,void 0!==a.audioCodec?e.audioCodec=a.audioCodec.toLowerCase():e.audioCodec=null,e.isOutgoing=!0,e.turn&&e.turn.urls){var h=[];e.turn.urls.forEach(function(a){h.push({url:a,urls:a,username:e.turn.username,credential:e.turn.credential})}),h.length>0&&(e.pc_config={iceServers:h})}e.pc=new RTCPeerConnection(e.pc_config),e.localStream&&e.pc.addStream(e.localStream),e.pc.oniceconnectionstatechange=function(a){var b=a;a.target&&a.target.iceConnectionState&&(b=a.target.iceConnectionState),console.log("iceConnectionState: "+b),"connected"===b?e.delegate.establishedConnection&&e.delegate.establishedConnection(e):"failed"===b?(e.call.delegate.callFailed&&e.delegate.callFailed(e,"establishing secure connecton failed"),e.terminate()):"disconnected"!==b&&"closed"!==b||(e.delegate.callTerminated&&e.delegate.callTerminated(e),e.terminate())},e.pc.onaddstream=function(a){e.remoteStream=a.stream,attachMediaStream(e.remoteMedia,e.remoteStream)};var i=[];e.pc.onicecandidate=function(a){if(a&&a.candidate&&a.candidate.candidate){var b=a.candidate,c={candidate:b.candidate};void 0!=b.sdpMid&&(c.sdpMid=b.sdpMid),void 0!=b.sdpMLineIndex&&(c.sdpMLineIndex=b.sdpMLineIndex),i.push(c)}else if(e.localDescription){var d={sessionOffer:{sdp:e.localDescription.sdp,candidates:i,uuid:e.uuid,replacesUuid:g}};e.client.sendWebRtcRequest(d,e.uuid,e.peerAddress)}},e.pc.createOffer(function(a){e.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,e.audioCodec)),e.pc.setLocalDescription(a,function(){e.localDescription=a},function(a){e.delegate.callFailed&&e.delegate.callFailed(e,a)})},function(a){e.delegate.callFailed&&e.delegate.callFailed(e,a)})},AhoySipCall.prototype.directAnswer=function(a,b,c){var d=this;if(!d.isAnswered){if(d.localStream=b,d.remoteMedia=c,d.isAnswered=!0,void 0!==a.audioCodec?d.audioCodec=a.audioCodec.toLowerCase():d.audioCodec=null,d.turn&&d.turn.urls){var e=[];d.turn.urls.forEach(function(a){e.push({url:a,urls:a,username:d.turn.username,credential:d.turn.credential})}),e.length>0&&(d.pc_config={iceServers:e})}d.pc=new RTCPeerConnection(d.pc_config),d.pc=new RTCPeerConnection(d.pc_config),d.localStream&&d.pc.addStream(d.localStream),d.pc.oniceconnectionstatechange=function(a){var b=a;a.target&&a.target.iceConnectionState&&(b=a.target.iceConnectionState),console.log("iceConnectionState: "+b),"connected"===b?d.delegate.establishedConnection&&d.delegate.establishedConnection(d):"failed"===b?(d.call.delegate.callFailed&&d.delegate.callFailed(d,"establishing secure connecton failed"),d.terminate()):"disconnected"!==b&&"closed"!==b||(d.delegate.callTerminated&&d.delegate.callTerminated(d),d.terminate())};var f=[];d.pc.onicecandidate=function(a){if(a&&a.candidate&&a.candidate.candidate){var b=a.candidate,c={candidate:b.candidate};void 0!=b.sdpMid&&(c.sdpMid=b.sdpMid),void 0!=b.sdpMLineIndex&&(c.sdpMLineIndex=b.sdpMLineIndex),f.push(c)}else d.localDescription&&d.sendSessionAnswer(f)},d.pc.onaddstream=function(a){d.remoteStream=a.stream,attachMediaStream(d.remoteMedia,d.remoteStream)},d.remoteDescription&&d.pc.setRemoteDescription(d.remoteDescription,function(){d.remoteDescription=null,d.remoteIceCandidates.forEach(function(a){d.pc.addIceCandidate(a)}),d.remoteIceCandidates=[],d.pc.createAnswer(function(a){d.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,d.audioCodec)),d.pc.setLocalDescription(a,function(){d.localDescription=a},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject()})},function(a){console.log(a),d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})}},AhoySipCall.prototype.answer=function(a,b,c){var d=this;if(!d.isAnswered){if(a.p2p===!0&&d.sip.xAhoyId)return d.directConnect(a,b,c,d.sip.xAhoyId);if(d.localStream=b,d.remoteMedia=c,d.isAnswered=!0,void 0!==a.audioCodec?d.audioCodec=a.audioCodec.toLowerCase():d.audioCodec=null,d.turn&&d.turn.urls){var e=[];d.turn.urls.forEach(function(a){e.push({url:a,urls:a,username:d.turn.username,credential:d.turn.credential})}),e.length>0&&(d.pc_config={iceServers:e})}d.pc=new RTCPeerConnection(d.pc_config),d.pc=new RTCPeerConnection(d.pc_config),d.localStream&&d.pc.addStream(d.localStream),d.pc.oniceconnectionstatechange=function(a){var b=a;a.target&&a.target.iceConnectionState&&(b=a.target.iceConnectionState),console.log("iceConnectionState: "+b),"connected"===b?d.delegate.establishedConnection&&d.delegate.establishedConnection(d):"failed"===b?(d.call.delegate.callFailed&&d.delegate.callFailed(d,"establishing secure connecton failed"),d.terminate()):"disconnected"!==b&&"closed"!==b||(d.delegate.callTerminated&&d.delegate.callTerminated(d),d.terminate())},d.pc.onaddstream=function(a){d.remoteStream=a.stream,attachMediaStream(d.remoteMedia,d.remoteStream)},d.remoteDescription&&d.pc.setRemoteDescription(d.remoteDescription,function(){d.remoteDescription=null,d.pc.createAnswer(function(a){d.audioCodec&&(a.sdp=AhoySdpForceAudioCodec(a.sdp,d.audioCodec)),d.pc.setLocalDescription(a,function(){d.localDescription=a,d.sendSessionAnswer()},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject()})},function(a){console.log(a),d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})},function(a){d.delegate.callFailed&&d.delegate.callFailed(d,a),d.reject("error")})}},AhoySipRegistration.prototype.register=function(){var a=this,b=a.client.generateUuid(),c={registerRequest:{registrar:a.registrar,username:a.username,password:a.password,refresh:a.refresh,useragent:a.useragent,proxyUrl:a.proxyUrl?a.proxyUrl:null,uuid:b}};a.client.sendSipRequest(c,b,function(b){b&&b.registration?(a.id=b.registration.id,a.callback(b.error,a)):a.callback("error",a)})},AhoySipRegistration.prototype.unregister=function(){var a=this,b=a.client.generateUuid(),c={unregisterRequest:{registrationId:a.id,uuid:b}};a.client.sendSipRequest(c,b,function(b){a.client.removeSipRegistration(a.id),b&&b.registration?a.callback(b.error,a):a.callback("error",a);
})},AhoySipRegistration.prototype.call=function(a,b,c,d){var e=this,f=a.calledParty,g=a.callingParty,h=a.timeout;"string"==typeof f&&(f={number:f}),g?"string"==typeof g&&(g={number:g}):g={number:e.username};var i={audioCodec:a.audioCodec,calledParty:f,callingParty:g,timeout:h},j=new AhoySipCall(null,i,b,c,e.client,d);return j&&(e.client.addCall(j.uuid,j),j.startCall()),j};var RTC2SIP=RTC2SIP||{errorCallback:null,ws:null,generateUuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},send:function(a){var b=this;b.ws&&b.ws.send(JSON.stringify(a))},sendMessage:function(a,b){var c=this,d={message:a,to:b,uuid:c.generateUuid()};c.send({messageRequest:d})},initCallback:null,requests:0,requestCallbacks:{},sipRegistrations:{},calls:{},sendRequest:function(a,b,c,d){var e=this;d&&(e.requestCallbacks[b]=d),e.sendMessage(a,c)},sendSipRequest:function(a,b,c){var d=this;d.sendRequest({sip:a},b,null,c)},sendWebRtcRequest:function(a,b,c){var d=this;d.sendRequest({webrtc:a},b,c)},sendWebRtcResponse:function(a,b){var c=this;c.sendMessage({webrtc:a},b)},handleSip:function(a){var b=this,c=null,d=null,e=null;a.registerResponse&&(c=a.registerResponse.uuid,d=b.requestCallbacks[c],e=a.registerResponse),d?d(e):console.log("no callback for "+JSON.stringify(a))},handleWebRtc:function(a,b){var c=this,d=null,e=null,f=null,g=null;if(a.sessionOffer?(e=a.sessionOffer.uuid,g=a.sessionOffer.sdp,f="sessionOffer"):a.sessionAnswer?(e=a.sessionAnswer.uuid,g=a.sessionAnswer.sdp,f="sessionAnswer"):a.sessionAcknowledge?(e=a.sessionAcknowledge.uuid,f="sessionAcknowledge"):a.sessionProgress?(e=a.sessionProgress.uuid,g=a.sessionProgress.sdp,f="sessionProgress"):a.sessionReject?(e=a.sessionReject.uuid,f="sessionReject"):a.sessionCancel?(e=a.sessionCancel.uuid,f="sessionCancel"):a.sessionTerminate?(e=a.sessionTerminate.uuid,f="sessionTerminate"):a.sessionConfirm&&(e=a.sessionConfirm.uuid,f="sessionConfirm"),!e||!f)return console.log("no uuid "+e+" or messageType "+f),void console.log(a);var h=c.calls[e];if(console.log("< "+f+" uuid "+e+" call "+h),h)h.handleWebRtc(a,b);else{if("sessionOffer"!==f)return;var i=!0,j=Object.keys(c.calls).length;if(0==j||c.isCallWaitingEnabled||a.sessionOffer.replacesUuid)if(a.sessionOffer.sip&&a.sessionOffer.sip.registrationId){if(d=a.sessionOffer.sip.registrationId,d&&c.sipRegistrations[d]){var k="anonymous",l=null,m="unknown";a.sessionOffer.sip.callingPartyNumber&&(k=a.sessionOffer.sip.callingPartyNumber),l=a.sessionOffer.sip.callingPartyName?a.sessionOffer.sip.callingPartyName:k,a.sessionOffer.sip.calledPartyNumber&&(m=a.sessionOffer.sip.calledPartyNumber);var n=c.sipRegistrations[d];if(n){console.log("incoming SIP call for registration "+n.id);var o={peerAddress:b,sip:a.sessionOffer.sip,calledParty:{number:m},callingParty:{number:k,name:l}},h=new AhoySipCall(e,o,null,null,c,null);g&&(h.remoteDescription=new RTCSessionDescription({type:"offer",sdp:g})),c.calls[h.uuid]=h,n.delegate.callReceived(h),i=!1}}}else if(a.sessionOffer.replacesUuid){var h=c.calls[a.sessionOffer.replacesUuid];if(h){var p=h.localStream,q=h.remoteMedia,r=h.delegate;h.terminate();var o={peerAddress:b};if(h=new AhoySipCall(e,o,null,null,c,r),g&&(h.remoteDescription=new RTCSessionDescription({type:"offer",sdp:g})),a.sessionOffer.candidates){var s=a.sessionOffer.candidates;s&&s.length&&s.forEach(function(a){try{var b=new RTCIceCandidate(a);h.remoteIceCandidates.push(b)}catch(c){}})}c.calls[h.uuid]=h,h.directAnswer({},p,q),i=!1}}i&&c.sendWebRtcResponse({sessionReject:{uuid:e,reason:"busy"}},b)}},handleMessageEvent:function(a){var b=this;a.message.webrtc&&b.handleWebRtc(a.message.webrtc,a.from),a.message.sip&&b.handleSip(a.message.sip)},init:function(a,b){var c=this;c.errorCallback=b,c.wsUrl=a.wsUrl,c.isCallWaitingEnabled=void 0!==a.enableCallWaiting?a.enableCallWaiting:!1,c.ws||(c.initCallback=function(a){c.initCallback=null,b(a)},c.ws=new WebSocket(c.wsUrl,"ahoyrtc-protocol"),c.ws.onopen=function(){c.send({identityRequest:{uuid:c.generateUuid()}})},c.ws.onerror=function(a){console.log(a),b("rtc2sip_init_failed")},c.ws.onmessage=function(a){var b=null;try{b=JSON.parse(a.data)}catch(d){console.log(d)}b&&(b.messageEvent?c.handleMessageEvent(b.messageEvent):b.identityResponse&&(b.identityResponse.success?(c.address=b.identityResponse.address,c.subAddress=c.address+"_"+b.identityResponse.session,c.initCallback&&c.initCallback()):c.initCallbacK("failed")))})},register:function(a,b,c){var d=this,e=function(a,b){!a&&b?d.sipRegistrations[b.id]=b:void 0!==d.sipRegistrations[b.id]&&delete d.sipRegistrations[b.id],c(a,b)};new AhoySipRegistration(a,d,b,e)},call:function(a,b,c,d){var e=this,f=a.calledParty,g=a.callingParty,h=a.timeout?a.timeout:-1;"string"==typeof f&&(f={number:f}),g?"string"==typeof g&&(g={number:g}):g={number:"anonymous"};var i={constraints:a.constraints,peerAddress:a.peerAddress,audioCodec:a.audioCodec,sip:a.sip,calledParty:f,callingParty:g,timeout:h},j=new AhoySipCall(null,i,b,c,e,d);return j&&(e.addCall(j.uuid,j),j.startCall()),j},addCall:function(a,b){var c=this;c.calls[a]=b},removeCall:function(a){var b=this;delete b.calls[a]},removeSipRegistration:function(a){var b=this;delete b.sipRegistrationsid[a]},stopMediaStream:function(a){if(a){for(var b=a.getAudioTracks(),c=0;c<b.length;c++)b[c].stop();for(var d=a.getVideoTracks(),c=0;c<d.length;c++)d[c].stop()}}};
//# sourceMappingURL=rtc2sip.min.js.map